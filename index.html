<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Professional Trading Journal (Dark/Light Mode)</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    
    <style>
        /* جميع الأنماط الأصلية تبقى كما هي */
        :root {
            --bg-body: #1a1a2e; 
            --bg-container: #1f283d; 
            --text-primary: #e0e0e0;
            --text-secondary: #a0a0a0;
            --color-highlight: #00bcd4; 
            --bg-day-label: #2c3a50; 
            --bg-cell-base: #2a3447; 
            --bg-cell-hover: #3b465b;
            --border-cell: #444f60;
            --bg-holiday: #3a475d;
            --text-holiday: #708090;
            --bg-inactive: #2c3a50;
            --opacity-inactive: 0.7;
            --bg-total-neutral: #29384d; 
            --border-total-neutral: #5d7088;
            --bg-sidebar: #121825; 
            --color-sidebar-link: #a0a0a0;
            --color-sidebar-link-hover: var(--color-highlight);
            --color-profit: #4caf50; 
            --color-loss: #f44336; 
            --bg-profit-total: #1B5E20;
            --text-profit-total: #E8F5E9;
            --bg-loss-total: #5C0000;
            --text-loss-total: #FFEBEE;
            --color-remaining-accent: #FFD700;
            --color-total-details: #B0C4DE;
            --bg-progress-bar: #555; 
            --color-progress: var(--color-profit);
            --color-achieved: var(--color-profit);
            --color-not-achieved: var(--color-loss);
        }

        .light-mode {
            --bg-body: #f0f2f5; 
            --bg-container: #ffffff; 
            --text-primary: #333333;
            --text-secondary: #666666;
            --color-highlight: #00796b; 
            --bg-day-label: #e0e0e0;
            --bg-cell-base: #ffffff;
            --bg-cell-hover: #f5f5f5;
            --border-cell: #cccccc;
            --bg-holiday: #e8e8e8;
            --text-holiday: #999999;
            --bg-inactive: #e0e0e0;
            --opacity-inactive: 0.9; 
            --bg-total-neutral: #e6f7f7; 
            --border-total-neutral: #b3e0e0;
            --bg-sidebar: #ffffff; 
            --color-sidebar-link: #333333;
            --color-sidebar-link-hover: var(--color-highlight);
            --color-profit: #2e7d32; 
            --color-loss: #d32f2f; 
            --bg-profit-total: #a5d6a7; 
            --text-profit-total: #1A5F16; 
            --bg-loss-total: #F87C63; 
            --text-loss-total: #69380C; 
            --color-remaining-accent:#4927F5;
            --color-total-details: #4927F5;
            --bg-progress-bar: #ccc; 
            --color-progress: var(--color-highlight);
            --color-achieved: var(--color-profit);
            --color-not-achieved: var(--color-loss);
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--bg-body); 
            color: var(--text-primary);
            line-height: 1.6;
            margin: 0;
            padding: 0;
            direction: ltr; 
            text-align: left; 
            transition: background-color 0.3s, color 0.3s;
            display: flex;
            min-height: 100vh;
        }
        
        .sidebar {
            width: 250px;
            background-color: var(--bg-sidebar);
            padding: 20px 0;
            box-shadow: 2px 0 5px rgba(0, 0, 0, 0.3);
            display: flex;
            flex-direction: column;
            transition: background-color 0.3s, color 0.3s;
            flex-shrink: 0; 
            z-index: 500; 
        }
        
        .profile-section {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 0 10px 30px;
            border-bottom: 1px solid var(--border-cell);
            margin-bottom: 20px;
        }
        
        .profile-pic-container {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            overflow: hidden;
            margin-bottom: 10px;
            border: 3px solid var(--color-highlight);
            background-color: var(--bg-day-label);
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        #profilePicture {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: none; 
        }

        .default-icon {
            font-size: 3em;
            color: var(--text-secondary);
        }

        #userNameDisplay {
            font-size: 1.4em;
            font-weight: bold;
            color: var(--text-primary);
        }

        .sidebar-menu a, .sidebar-menu div {
            padding: 12px 20px;
            cursor: pointer;
            color: var(--color-sidebar-link);
            text-decoration: none;
            display: block;
            font-size: 1.1em;
            transition: background-color 0.2s, color 0.2s;
            display: flex;
            align-items: center;
        }
        
        .sidebar-menu a:hover, .sidebar-menu div:hover {
            background-color: rgba(0, 188, 212, 0.1);
            color: var(--color-sidebar-link-hover);
        }
        
        .sidebar-menu i {
            margin-right: 10px;
            width: 20px; 
        }

        .theme-switch-container {
            display: flex;
            justify-content: flex-end;
            align-items: center;
            flex-grow: 1;
        }
        
        .switch {
            position: relative;
            display: inline-block;
            width: 45px;
            height: 24px;
        }
        
        .switch input { 
            opacity: 0;
            width: 0;
            height: 0;
        }
        
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: var(--bg-day-label); 
            transition: .4s;
            border-radius: 24px;
        }
        
        .slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 3px;
            bottom: 3px;
            background-color: var(--color-highlight);
            transition: .4s;
            border-radius: 50%;
        }
        
        input:checked + .slider {
            background-color: var(--color-highlight); 
        }
        
        input:checked + .slider:before {
            transform: translateX(20px);
            background-color: var(--bg-container);
        }

        .main-content {
            flex-grow: 1; 
            padding: 40px;
            margin: 0; 
            background-color: var(--bg-body); 
            transition: background-color 0.3s;
        }
        
        .container {
            max-width: 1200px; 
            margin: 0 auto; 
            padding: 30px;
            background-color: var(--bg-container); 
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2); 
            border-radius: 12px;
            transition: background-color 0.3s, box-shadow 0.3s;
        }

        h1 {
            text-align: center;
            color: var(--color-highlight); 
            margin-bottom: 30px;
        }

        .calendar-header {
            display: flex;
            justify-content: flex-start;
            align-items: center;
            margin-bottom: 20px;
            gap: 20px;
        }
        
        .month-nav-container {
            display: flex; 
            align-items: center; 
            gap: 10px;
            flex-grow: 1;
        }
        
        .calendar-header button {
            background: none;
            border: 1px solid var(--color-highlight);
            color: var(--color-highlight);
            font-size: 1.2em;
            cursor: pointer;
            padding: 5px 10px;
            border-radius: 5px;
            transition: background-color 0.3s, color 0.3s, border-color 0.3s;
        }
        
        .calendar-nav-btn {
             font-size: 1em !important; 
             padding: 5px 8px !important;
             width: auto;
        }
        .calendar-nav-btn i {
            pointer-events: none;
        }

        .calendar-header button:hover {
            background-color: var(--color-highlight);
            color: var(--bg-container);
        }

        .month-display {
            font-size: 2em;
            font-weight: bold;
            color: var(--text-primary);
            white-space: nowrap; 
        }

        .summary-display {
            font-size: 1.2em;
            font-weight: 500;
            margin-left: auto;
        }
        
        .today-btn {
            font-size: 1em !important; 
            padding: 3px 8px !important; 
            border-radius: 4px !important;
            background-color: var(--color-highlight) !important;
            color: var(--bg-container) !important;
            border: none !important;
            white-space: nowrap; 
            cursor: pointer;
        }
        .today-btn:hover {
            opacity: 0.9;
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(8, 1fr);
            gap: 5px;
            margin-top: 20px;
        }

        .day-label, .week-total-label {
            background-color: var(--bg-day-label);
            color: var(--text-secondary);
            font-weight: bold;
            text-align: center;
            padding: 10px 5px;
            border-radius: 4px;
            font-size: 0.9em;
            transition: background-color 0.3s, color 0.3s;
        }
        
        .calendar-cell {
            background-color: var(--bg-cell-base);
            padding: 10px;
            border-radius: 4px;
            min-height: 90px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            box-shadow: 0 0 5px rgba(0, 0, 0, 0.1); 
            cursor: pointer;
            transition: background-color 0.2s, border-color 0.2s, box-shadow 0.2s;
            border: 1px solid var(--border-cell);
        }

        .calendar-cell:hover:not(.holiday):not(.empty-cell):not(.no-trading-day) {
            background-color: var(--bg-cell-hover);
            border: 1px solid var(--color-highlight);
        }
        
        .calendar-cell.inactive-day {
            background-color: var(--bg-inactive); 
            opacity: var(--opacity-inactive); 
        }

        .calendar-cell.holiday {
            background-color: var(--bg-holiday); 
            color: var(--text-holiday);
            cursor: default;
            opacity: 0.8;
            border: none;
            transition: background-color 0.3s, color 0.3s;
        }
        
        .calendar-cell.empty-cell {
            background-color: var(--bg-day-label);
            cursor: default;
            border: none;
            transition: background-color 0.3s;
        }

        .calendar-cell.no-trading-day {
            background-color: var(--bg-holiday) !important;
            opacity: 0.6;
            border: 2px dashed var(--text-secondary) !important;
        }

        .calendar-cell.no-trading-day:hover {
            background-color: var(--bg-holiday) !important;
            border: 2px dashed var(--color-highlight) !important;
        }

        .no-trading-indicator {
            color: var(--text-secondary);
            font-size: 0.8em;
            margin-right: auto;
            margin-left: 5px;
        }

        .calendar-cell.no-trading-day .daily-pnl {
            color: var(--text-secondary) !important;
            font-style: italic;
        }

        .calendar-cell.no-trading-day .trade-count {
            color: var(--text-secondary);
            font-weight: bold;
        }

        @keyframes liveGlow {
            0% { opacity: 1; text-shadow: 0 0 5px var(--color-highlight); }
            50% { opacity: 0.5; text-shadow: none; }
            100% { opacity: 1; text-shadow: 0 0 5px var(--color-highlight); }
        }

        .calendar-cell.today-cell {
            border: 3px solid var(--color-highlight); 
            background-color: var(--bg-cell-hover); 
        }

        .day-number {
            font-size: 1.1em;
            font-weight: bold;
            color: var(--text-secondary);
            text-align: right; 
            display: flex;
            justify-content: flex-end; 
            align-items: center;
        }
        
        .live-indicator {
            font-size: 0.7em;
            font-weight: bold;
            color: var(--color-profit); 
            margin-right: auto; 
            margin-left: 5px; 
            padding: 2px 4px;
            background-color: rgba(76, 175, 80, 0.15); 
            border-radius: 3px;
            animation: liveGlow 1.5s infinite alternate; 
            transition: background-color 0.3s;
        }

        .daily-pnl {
            font-size: 1.3em;
            font-weight: bold;
            text-align: center;
        }

        .trade-count {
            font-size: 0.8em;
            color: var(--text-secondary);
            text-align: center;
            transition: color 0.3s;
        }
        
        .week-total-cell {
            background-color: var(--bg-total-neutral); 
            color: var(--text-primary);
            font-weight: bold;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            min-height: 90px;
            border-radius: 4px;
            padding: 5px;
            border: 1px solid var(--border-total-neutral); 
            transition: background-color 0.3s, border-color 0.3s, color 0.3s; 
        }
        
        .week-total-cell.inactive-total {
            background-color: var(--bg-inactive); 
            border: 1px solid var(--border-cell);
            opacity: var(--opacity-inactive);
            color: var(--text-secondary); 
        }
        
        .week-total-cell.weekly-profit {
            background-color: var(--bg-profit-total); 
            border-color: var(--color-profit); 
            opacity: 1; 
        }
        
        .week-total-cell.weekly-loss {
            background-color: var(--bg-loss-total); 
            border-color: var(--color-remaining-loss); 
            opacity: 1; 
        }

        .profit {
            color: var(--color-profit); 
        }

        .loss {
            color: var(--color-loss); 
        }
        
        .remaining-loss {
            color: var(--color-remaining-accent) !important; 
            font-weight: bold;
        }
        
        .achieved-text {
            color: var(--color-remaining-accent) !important; 
            font-weight: bold;
        }
        
        .week-total-cell.weekly-profit * {
            color: var(--text-profit-total);
        }

        .week-total-cell.weekly-loss * {
            color: var(--text-loss-total);
        }
        
        .week-total-cell.weekly-profit .daily-pnl,
        .week-total-cell.weekly-profit .profit {
             color: var(--text-profit-total) !important; 
        }

        .week-total-cell.weekly-loss .daily-pnl,
        .week-total-cell.weekly-loss .loss {
             color: var(--text-loss-total) !important; 
        }

        .plan-summary {
            display: flex; 
            flex-direction: column;
            gap: 15px; 
            margin-top: 30px; 
            padding: 20px;
            background-color: var(--bg-day-label); 
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
            transition: background-color 0.3s;
        }

        .plan-item.general-capital {
            background-color: var(--bg-container);
            padding: 15px;
            border-radius: 6px;
            text-align: center;
            margin-bottom: 10px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }
        
        .plan-item.general-capital h4 {
            margin: 0 0 5px 0;
            color: var(--text-secondary);
        }
        
        .plan-item.general-capital p {
            margin: 0;
            font-size: 1.6em;
            font-weight: bold;
            color: var(--text-primary);
        }

        .goals-container {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
        }

        .period-summary-item {
            display: flex;
            flex-direction: column;
            padding: 15px;
            background-color: var(--bg-container);
            border-radius: 6px;
            border: 1px solid var(--border-cell);
            transition: background-color 0.3s;
        }
        
        .period-summary-item.disabled-goal {
            opacity: 0.5; 
            background-color: var(--bg-inactive); 
            border: 1px dashed var(--text-secondary); 
        }

        .period-summary-item.disabled-goal h4 {
            color: var(--text-secondary) !important;
        }

        .period-summary-item h4 {
            margin: 0 0 10px 0;
            color: var(--color-highlight);
            font-size: 1.1em;
            text-align: center;
        }

        .pnl-and-goal-row {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-bottom: 10px;
            font-size: 0.9em;
        }

        .pnl-and-goal-row p {
            margin: 2px 0;
            text-align: center;
        }

        .pnl-and-goal-row .goal-pct {
            font-weight: bold;
            color: var(--text-primary);
            font-size: 1.1em;
        }
        
        .progress-bar-container {
            width: 100%;
            height: 20px;
            background-color: var(--bg-progress-bar);
            border-radius: 8px;
            overflow: hidden;
            margin: 5px 0 10px;
            position: relative; 
        }

        .progress-bar {
            height: 100%;
            width: 0%; 
            background-color: var(--color-progress);
            transition: width 0.5s ease-out;
            border-radius: 8px 0 0 8px;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .progress-text {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8em;
            font-weight: bold;
            color: white;
            text-shadow: 0 0 2px rgba(0, 0, 0, 0.5);
            z-index: 2;
            pointer-events: none;
        }
        
        .achievement-status {
            text-align: center;
            padding: 5px 0;
            font-size: 0.9em;
            font-weight: bold;
            border-top: 1px dashed var(--border-cell);
            margin-top: auto;
        }

        .achievement-status i {
            margin-right: 5px;
        }
        
        .achievement-status.achieved {
            color: var(--color-achieved);
        }

        .achievement-status.not-achieved {
            color: var(--color-not-achieved);
        }
        
        .achievement-status.not-set {
            color: var(--text-secondary); 
            font-style: italic;
        }

        .modal {
            display: none; 
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.6);
            justify-content: center; 
            align-items: center;
        }

        .modal-content {
            background-color: var(--bg-container);
            padding: 30px;
            border-radius: 10px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.8);
            position: relative;
            transition: background-color 0.3s;
            margin: auto; 
        }
        
        #tradeModal .modal-content {
            max-width: 800px;
        }
        
        #dailyTradesList {
            max-height: 250px;
            overflow-y: auto;
            padding: 10px;
            border: 1px solid var(--border-cell);
            border-radius: 4px;
            margin-bottom: 20px;
            background-color: var(--bg-cell-base);
            transition: background-color 0.3s, border-color 0.3s;
        }

        .trade-header, .daily-trade-item {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr 1fr 1.2fr 1.5fr 1fr; 
            align-items: center;
            padding: 8px 5px;
            border-bottom: 1px dashed var(--border-cell);
            font-size: 0.95em;
            transition: border-color 0.3s;
        }

        .trade-header {
            font-weight: bold;
            color: var(--color-highlight);
            border-bottom: 2px solid var(--color-highlight);
        }

        .daily-trade-item:last-child {
            border-bottom: none;
        }
        
        .daily-trade-item button {
            background-color: var(--bg-holiday); 
            color: var(--text-primary);
            border: none;
            padding: 5px 8px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.85em;
            margin: 0 3px;
            transition: background-color 0.3s, color 0.3s;
        }

        .daily-trade-item button.delete-btn {
            background-color: var(--color-loss);
            color: white; 
        }
        .daily-trade-item button.edit-btn {
            background-color: var(--color-highlight);
            color: white; 
        }

        .daily-trade-item button:hover {
            opacity: 0.8;
        }
        
        #tradeForm, #userInfoForm, #planForm {
            display: grid;
            grid-template-columns: 1fr 1fr; 
            gap: 20px; 
        }
        
        #tradeForm {
            grid-template-columns: repeat(2, 1fr);
        }
        
        #simpleFormWrapper {
            display: grid; 
            grid-template-columns: 1fr 1fr; 
            gap: 20px;
        }

        .input-group {
            margin-bottom: 0; 
            display: flex;
            flex-direction: column;
        }
        
        .input-group label {
            font-weight: bold;
            color: var(--text-secondary); 
            margin-bottom: 5px;
            font-size: 0.9em;
            transition: color 0.3s;
        }

        .input-group input[type="text"], 
        .input-group input[type="number"],
        .input-group input[type="file"],
        .input-group select,
        .input-group input[type="datetime-local"] { 
            padding: 10px;
            border: 1px solid var(--border-cell);
            background-color: var(--bg-inactive); 
            color: var(--text-primary);
            border-radius: 4px;
            font-size: 1em;
            transition: border-color 0.3s, box-shadow 0.3s, background-color 0.3s, color 0.3s;
        }

        .input-group input:focus,
        .input-group select:focus {
            border-color: var(--color-highlight); 
            box-shadow: 0 0 5px rgba(0, 188, 212, 0.5);
            outline: none; 
        }
        
        .time-input-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        
        .time-input-row {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        .time-input-row label {
            min-width: 80px;
            font-weight: bold;
            color: var(--text-secondary);
            font-size: 0.9em;
        }
        
        .time-input-row input {
            flex: 1;
            padding: 8px;
            border: 1px solid var(--border-cell);
            background-color: var(--bg-inactive);
            color: var(--text-primary);
            border-radius: 4px;
            font-size: 0.9em;
        }
        
        #submitButton, #saveUserInfoBtn, #savePlanBtn, #submitSimplePnLButton {
            grid-column: 1 / -1; 
            padding: 12px;
            background-color: var(--color-highlight);
            color: var(--bg-container); 
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1.1em;
            transition: background-color 0.3s, color 0.3s;
            margin-top: 5px;
        }
        
        #submitButton:hover, #saveUserInfoBtn:hover, #savePlanBtn:hover, #submitSimplePnLButton:hover {
            opacity: 0.9;
        }

        .close-btn {
            color: var(--text-secondary);
            font-size: 28px;
            font-weight: bold;
            position: absolute;
            top: 10px;
            right: 10px; 
            cursor: pointer;
            transition: color 0.3s;
        }
        
        .analytics-section {
            background-color: var(--bg-container);
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            margin-top: 30px;
        }
        
        .analytics-controls {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-bottom: 25px;
            flex-wrap: wrap;
        }
        
        .analytics-period-selector,
        .analytics-metric-selector {
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        
        .analytics-controls label {
            font-weight: bold;
            color: var(--text-secondary);
            margin-bottom: 5px;
            font-size: 0.9em;
        }
        
        .analytics-controls select {
            padding: 8px 12px;
            border: 1px solid var(--border-cell);
            background-color: var(--bg-inactive);
            color: var(--text-primary);
            border-radius: 4px;
            font-size: 1em;
            transition: border-color 0.3s, box-shadow 0.3s;
        }
        
        .analytics-controls select:focus {
            border-color: var(--color-highlight);
            box-shadow: 0 0 5px rgba(0, 188, 212, 0.5);
            outline: none;
        }
        
        .chart-container {
            position: relative;
            height: 350px;
            margin-bottom: 25px;
            background-color: var(--bg-day-label);
            border-radius: 8px;
            padding: 15px;
        }
        
        .analytics-summary {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
        }
        
        .summary-card {
            background-color: var(--bg-day-label);
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }
        
        .summary-card h4 {
            margin: 0 0 10px 0;
            color: var(--text-secondary);
            font-size: 0.9em;
        }
        
        .summary-card p {
            margin: 0;
            font-size: 1.3em;
            font-weight: bold;
        }
        
        .days-statistics-section {
            background-color: var(--bg-container);
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            margin-top: 30px;
        }
        
        .days-statistics {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 15px;
        }
        
        .day-stat-card {
            background-color: var(--bg-day-label);
            padding: 20px;
            border-radius: 8px;
            text-align: center;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }
        
        .day-stat-card h4 {
            margin: 0 0 10px 0;
            color: var(--text-secondary);
            font-size: 1em;
        }
        
        .day-stat-card p {
            margin: 0;
            font-size: 1.8em;
            font-weight: bold;
            color: var(--color-highlight);
        }
        
        .day-stat-card small {
            color: var(--text-secondary);
            font-size: 0.8em;
        }
        
        .trade-mode-toggle-container {
            display: flex;
            justify-content: center;
            align-items: center;
            margin-bottom: 20px;
            padding: 15px;
            background-color: var(--bg-day-label);
            border-radius: 8px;
            border: 2px solid var(--border-cell);
        }
        
        .trade-mode-label {
            font-weight: bold;
            padding: 8px 15px;
            border-radius: 6px;
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .trade-mode-label.active {
            background-color: var(--color-highlight);
            color: var(--bg-container);
        }
        
        .trade-mode-label.inactive {
            background-color: var(--bg-inactive);
            color: var(--text-secondary);
        }
        
        .export-controls {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .export-period-selector {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .export-date-range {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }
        
        .export-options {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .export-checkbox {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .export-checkbox input {
            margin: 0;
        }

        .time-analysis-section {
            background-color: var(--bg-container);
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            margin-top: 30px;
        }
        
        .analysis-tabs {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 1px solid var(--border-cell);
        }
        
        .analysis-tab {
            padding: 10px 20px;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            transition: all 0.3s;
        }
        
        .analysis-tab.active {
            border-bottom: 2px solid var(--color-highlight);
            color: var(--color-highlight);
        }
        
        .analysis-content {
            display: none;
        }
        
        .analysis-content.active {
            display: block;
        }
        
        .analysis-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .analysis-card {
            background-color: var(--bg-day-label);
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }
        
        .analysis-card h4 {
            margin: 0 0 15px 0;
            color: var(--color-highlight);
            text-align: center;
        }
        
        .analysis-stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }
        
        .stat-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 10px;
            background-color: var(--bg-container);
            border-radius: 6px;
        }
        
        .stat-value {
            font-size: 1.4em;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .stat-label {
            font-size: 0.8em;
            color: var(--text-secondary);
            text-align: center;
        }

        /* Mobile Styles */
        .hamburger-menu {
            display: none;
            flex-direction: column;
            cursor: pointer;
            padding: 10px;
            position: fixed;
            top: 10px;
            right: 10px;
            z-index: 1000;
            background-color: var(--bg-container);
            border-radius: 5px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
        }

        .hamburger-line {
            width: 25px;
            height: 3px;
            background-color: var(--text-primary);
            margin: 3px 0;
            transition: 0.3s;
        }

        .mobile-menu {
            display: none;
            position: fixed;
            top: 0;
            right: 0;
            width: 250px;
            height: 100vh;
            background-color: var(--bg-sidebar);
            z-index: 999;
            padding: 60px 20px 20px;
            box-shadow: -2px 0 10px rgba(0,0,0,0.3);
            overflow-y: auto;
        }

        .mobile-menu.active {
            display: block;
        }

        .mobile-menu-item {
            padding: 15px;
            color: var(--color-sidebar-link);
            text-decoration: none;
            display: block;
            border-bottom: 1px solid var(--border-cell);
            cursor: pointer;
            transition: all 0.3s;
        }

        .mobile-menu-item:hover {
            background-color: rgba(0, 188, 212, 0.1);
            color: var(--color-sidebar-link-hover);
        }

        .mobile-menu-item i {
            margin-right: 10px;
            width: 20px;
        }

        .close-mobile-menu {
            position: absolute;
            top: 15px;
            right: 15px;
            font-size: 24px;
            color: var(--text-secondary);
            cursor: pointer;
        }

        /* Mobile Calendar */
        .mobile-calendar-grid {
            display: none;
            flex-direction: column;
            gap: 10px;
            margin-top: 20px;
        }

        .mobile-week {
            display: flex;
            flex-direction: column;
            gap: 5px;
            margin-bottom: 15px;
        }

        .mobile-week-row {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 3px;
        }

        .mobile-week-total-row {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 3px;
        }

        .mobile-calendar-cell {
            background-color: var(--bg-cell-base);
            padding: 8px 5px;
            border-radius: 4px;
            min-height: 70px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            transition: background-color 0.2s, border-color 0.2s;
            border: 1px solid var(--border-cell);
            position: relative;
        }

        .mobile-day-name {
            font-size: 0.65em;
            color: var(--text-secondary);
            font-weight: bold;
            text-align: center;
            margin-bottom: 3px;
            text-transform: uppercase;
        }

        .mobile-day-number {
            font-size: 0.9em;
            font-weight: bold;
            color: var(--text-secondary);
            text-align: center;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 2px;
        }

        .mobile-daily-pnl {
            font-size: 0.8em;
            font-weight: bold;
            text-align: center;
            margin: 2px 0;
        }

        .mobile-trade-count {
            font-size: 0.65em;
            color: var(--text-secondary);
            text-align: center;
        }

        .mobile-week-total-cell {
            background-color: var(--bg-total-neutral);
            color: var(--text-primary);
            font-weight: bold;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            min-height: 70px;
            border-radius: 4px;
            padding: 5px;
            border: 1px solid var(--border-total-neutral);
            grid-column: 1 / -1;
        }

        @media (max-width: 1024px) {
            .container {
                padding: 20px;
                max-width: 95%; 
            }
            .main-content {
                padding: 20px; 
            }
            .calendar-header {
                flex-wrap: wrap;
                gap: 10px;
            }
            .month-display {
                font-size: 1.8em;
            }
            .summary-display {
                margin-top: 10px;
                margin-left: 0;
                width: 100%;
                text-align: right;
            }
            
            .analytics-summary {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .chart-container {
                height: 300px;
            }
            
            .days-statistics {
                grid-template-columns: repeat(3, 1fr);
            }
            
            .analysis-grid {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 768px) {
            body {
                flex-direction: column;
            }

            .sidebar {
                display: none;
            }

            .hamburger-menu {
                display: flex;
            }

            .main-content {
                padding: 60px 15px 15px;
                width: 100%;
            }
            
            .container {
                padding: 15px;
                width: 100%;
                box-sizing: border-box;
            }
            
            .calendar-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }
            .month-nav-container {
                width: 100%;
                justify-content: space-between;
            }
            .summary-display {
                order: 3;
                width: 100%;
                text-align: left;
                font-size: 1em;
            }
            
            /* Hide desktop calendar, show mobile calendar */
            .calendar-grid {
                display: none;
            }
            
            .mobile-calendar-grid {
                display: flex;
            }
            
            .week-total-label {
                display: none;
            }
            
            .day-label, .calendar-cell {
                 font-size: 0.8em;
                 min-height: 70px;
            }
            
            .day-number {
                font-size: 0.9em;
            }

            .daily-pnl {
                font-size: 1em;
            }
            
            .goals-container {
                grid-template-columns: 1fr;
                gap: 15px;
            }
            
            .modal-content {
                max-width: 95%;
                padding: 20px;
            }
            #tradeModal .modal-content {
                max-width: 95%;
            }
            
            .trade-header, .daily-trade-item {
                grid-template-columns: 1fr 1fr 1fr 1fr;
                font-size: 0.8em;
                padding: 5px 3px;
            }
            .daily-trade-item span:nth-child(2),
            .daily-trade-item span:nth-child(3),
            .daily-trade-item span:nth-child(4)
            {
                display: none;
            }
            
            .trade-header span:nth-child(2), 
            .trade-header span:nth-child(3), 
            .trade-header span:nth-child(4) {
                 display: none;
            }
            
            #tradeForm, #userInfoForm, #planForm {
                grid-template-columns: 1fr;
                gap: 15px;
            }
            #tradeForm {
                grid-template-columns: 1fr;
            }
            #simpleFormWrapper {
                grid-template-columns: 1fr;
            }
            
            .analytics-summary {
                grid-template-columns: 1fr;
            }
            
            .chart-container {
                height: 250px;
            }
            
            .analytics-controls {
                flex-direction: column;
                align-items: center;
            }
            
            .days-statistics {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .analysis-tabs {
                flex-wrap: wrap;
            }
            
            .analysis-tab {
                padding: 8px 12px;
                font-size: 0.9em;
            }
            
            .time-input-row {
                flex-direction: column;
                gap: 5px;
            }
            
            .time-input-row label {
                min-width: auto;
            }

            .mobile-week-row,
            .mobile-week-total-row {
                grid-template-columns: repeat(4, 1fr);
            }

            .mobile-calendar-cell.holiday {
                background-color: var(--bg-holiday);
                color: var(--text-holiday);
                cursor: default;
            }

            .mobile-calendar-cell.today-cell {
                border: 2px solid var(--color-highlight);
                background-color: var(--bg-cell-hover);
            }

            .mobile-calendar-cell.no-trading-day {
                background-color: var(--bg-holiday);
                opacity: 0.6;
                border: 2px dashed var(--text-secondary);
            }

            .mobile-calendar-cell.inactive-day {
                background-color: var(--bg-inactive);
                opacity: var(--opacity-inactive);
            }
        }
        
        @media (max-width: 480px) {
            .mobile-week-row,
            .mobile-week-total-row {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .mobile-calendar-cell {
                min-height: 65px;
                padding: 6px 3px;
            }
            
            .mobile-day-name {
                font-size: 0.6em;
            }
            
            .mobile-daily-pnl {
                font-size: 0.75em;
            }
            
            .mobile-trade-count {
                font-size: 0.6em;
            }
            
            .month-display {
                font-size: 1.5em;
            }
            
            .analysis-stats {
                grid-template-columns: 1fr;
            }
            
            .days-statistics {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body class="dark-mode"> 
    
    <!-- Mobile Hamburger Menu -->
    <div class="hamburger-menu" id="hamburgerMenu">
        <div class="hamburger-line"></div>
        <div class="hamburger-line"></div>
        <div class="hamburger-line"></div>
    </div>

    <!-- Mobile Menu -->
    <div class="mobile-menu" id="mobileMenu">
        <span class="close-mobile-menu" onclick="closeMobileMenu()">&times;</span>
        
        <div class="mobile-menu-item" onclick="openUserInfoModal(); closeMobileMenu();">
            <i class="fas fa-user-circle"></i> User Info
        </div>
        <div class="mobile-menu-item" onclick="openPlanModal(); closeMobileMenu();">
            <i class="fas fa-bullseye"></i> Plan
        </div>
        <div class="mobile-menu-item" onclick="openTimeAnalysisModal(); closeMobileMenu();">
            <i class="fas fa-chart-bar"></i> Time Analysis
        </div>
        <div class="mobile-menu-item" onclick="openExportModal(); closeMobileMenu();">
            <i class="fas fa-file-export"></i> Data
        </div>
        <div class="mobile-menu-item" style="display: flex; justify-content: space-between; align-items: center;">
            <span><i class="fas fa-paint-brush"></i> Theme</span>
            <label class="switch">
                <input type="checkbox" id="mobileThemeToggle">
                <span class="slider"></span>
            </label>
        </div>
    </div>
    
    <div class="sidebar">
        <div class="profile-section">
            <div class="profile-pic-container">
                <i id="defaultIcon" class="fas fa-user default-icon"></i>
                <img id="profilePicture" src="" alt="User Profile">
            </div>
            <span id="userNameDisplay">User Name</span>
        </div>

        <div class="sidebar-menu">
            <div onclick="openUserInfoModal()">
                <i class="fas fa-user-circle"></i> User Info
            </div>
            <div onclick="openPlanModal()">
                <i class="fas fa-bullseye"></i> Plan
            </div>
            <div onclick="openTimeAnalysisModal()">
                <i class="fas fa-chart-bar"></i> Time Analysis
            </div>
            <div onclick="openExportModal()">
                <i class="fas fa-file-export"></i> Data
            </div>
            <div style="margin-top: 10px; border-top: 1px solid var(--border-cell);">
                <i class="fas fa-paint-brush"></i> Theme
                <div class="theme-switch-container">
                    <label class="switch">
                        <input type="checkbox" id="sidebarThemeToggle">
                        <span class="slider"></span>
                    </label>
                </div>
            </div>
        </div>
    </div>
    
    <div class="main-content">
        <div class="container">
            <h1>Professional Trading Journal</h1>
            
            <div class="calendar-header">
                
                <div class="month-nav-container">
                    <button onclick="changeMonth(-1)" class="calendar-nav-btn" title="Previous Month">
                        <i class="fas fa-chevron-left"></i>
                    </button>
                    
                    <span class="month-display" id="currentMonthYear"></span>
                    
                    <button onclick="changeMonth(1)" class="calendar-nav-btn" title="Next Month">
                        <i class="fas fa-chevron-right"></i>
                    </button>
                    
                    <button id="goToTodayBtn" class="today-btn" onclick="goToCurrentMonth()" style="display: none;">Today</button>
                </div>
                
                <span class="summary-display">
                    Monthly Total: <span id="monthlyPnlSummary" class="profit">$0.00</span>
                </span>
            </div>
            
            <!-- Desktop Calendar -->
            <div class="calendar-grid">
                <div class="day-label holiday">Sun</div>
                <div class="day-label">Mon</div>
                <div class="day-label">Tue</div>
                <div class="day-label">Wed</div>
                <div class="day-label">Thu</div>
                <div class="day-label">Fri</div>
                <div class="day-label holiday">Sat</div>
                <div class="week-total-label">Total</div>
            </div>

            <!-- Mobile Calendar -->
            <div class="mobile-calendar-grid" id="mobileCalendarGrid">
            </div>

            <div id="planSummary" class="plan-summary" style="display: none;">
                </div>
            
            <!-- Analytics Section -->
            <div id="analyticsSection" class="analytics-section">
                <h2 style="text-align: center; color: var(--color-highlight); margin-bottom: 20px;">
                    <i class="fas fa-chart-line"></i> Analytics Dashboard
                </h2>
                
                <div class="analytics-controls">
                    <div class="analytics-period-selector">
                        <label for="analyticsPeriod">Select Period:</label>
                        <select id="analyticsPeriod" onchange="updateAnalyticsChart()">
                            <option value="weekly">Weekly</option>
                            <option value="monthly">Monthly</option>
                            <option value="quarterly">Quarterly</option>
                            <option value="yearly">Yearly</option>
                            <option value="daily">Daily</option>
                        </select>
                    </div>
                    
                    <div class="analytics-metric-selector">
                        <label for="analyticsMetric">View:</label>
                        <select id="analyticsMetric" onchange="updateAnalyticsChart()">
                            <option value="pnl">Profit & Loss</option>
                            <option value="trades">Number of Trades</option>
                            <option value="winRate">Win Rate</option>
                            <option value="days">Trading Days Analysis</option>
                        </select>
                    </div>
                </div>
                
                <div class="chart-container">
                    <canvas id="analyticsChart"></canvas>
                </div>
                
                <div class="analytics-summary">
                    <div class="summary-card">
                        <h4>Total Profit</h4>
                        <p id="totalProfit" class="profit">$0.00</p>
                    </div>
                    <div class="summary-card">
                        <h4>Total Loss</h4>
                        <p id="totalLoss" class="loss">$0.00</p>
                    </div>
                    <div class="summary-card">
                        <h4>Net P&L</h4>
                        <p id="netPnl">$0.00</p>
                    </div>
                    <div class="summary-card">
                        <h4>Win Rate</h4>
                        <p id="winRate">0%</p>
                    </div>
                </div>
            </div>
            
            <!-- Days Statistics Section -->
            <div class="days-statistics-section">
                <h3 style="text-align: center; color: var(--color-highlight); margin-bottom: 20px;">
                    <i class="fas fa-calendar-alt"></i> Monthly Days Statistics
                </h3>
                <div class="days-statistics">
                    <div class="day-stat-card">
                        <h4>Trading Days</h4>
                        <p id="tradingDays">0</p>
                        <small>Days you actually traded</small>
                    </div>
                    <div class="day-stat-card">
                        <h4>No Trading Days</h4>
                        <p id="noTradingDays">0</p>
                        <small>Days marked as no trading</small>
                    </div>
                    <div class="day-stat-card">
                        <h4>Weekend Days</h4>
                        <p id="holidayDays">0</p>
                        <small>Saturday & Sunday</small>
                    </div>
                    <div class="day-stat-card">
                        <h4>Remaining Days</h4>
                        <p id="remainingDays">0</p>
                        <small>Days left this month</small>
                    </div>
                    <div class="day-stat-card">
                        <h4>Total Month Days</h4>
                        <p id="totalMonthDays">0</p>
                        <small>Total days in month</small>
                    </div>
                </div>
            </div>
            
        </div>
    </div>
    
    <!-- Time Analysis Modal -->
    <div id="timeAnalysisModal" class="modal">
        <div class="modal-content" style="max-width: 900px;">
            <span class="close-btn" onclick="closeModal('timeAnalysisModal')">&times;</span>
            <h2 style="text-align: center; color: var(--color-highlight); margin-bottom: 20px;">
                <i class="fas fa-clock"></i> Time Analysis
            </h2>
            
            <div class="analysis-tabs">
                <div class="analysis-tab active" onclick="switchAnalysisTab('winLossAnalysis')">
                    Win/Loss Analysis
                </div>
                <div class="analysis-tab" onclick="switchAnalysisTab('sessionAnalysis')">
                    Session Analysis
                </div>
                <div class="analysis-tab" onclick="switchAnalysisTab('timeAnalysis')">
                    Time Analysis
                </div>
            </div>
            
            <div id="winLossAnalysis" class="analysis-content active">
                <div class="analysis-grid">
                    <div class="analysis-card">
                        <h4>Winning Trades</h4>
                        <div class="analysis-stats">
                            <div class="stat-item">
                                <div class="stat-value profit" id="winningTradesCount">0</div>
                                <div class="stat-label">Total Trades</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-value profit" id="winningTradesPnl">$0.00</div>
                                <div class="stat-label">Total P&L</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-value" id="avgWinPnl">$0.00</div>
                                <div class="stat-label">Avg P&L per Trade</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-value" id="maxWinPnl">$0.00</div>
                                <div class="stat-label">Max Win</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="analysis-card">
                        <h4>Losing Trades</h4>
                        <div class="analysis-stats">
                            <div class="stat-item">
                                <div class="stat-value loss" id="losingTradesCount">0</div>
                                <div class="stat-label">Total Trades</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-value loss" id="losingTradesPnl">$0.00</div>
                                <div class="stat-label">Total P&L</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-value" id="avgLossPnl">$0.00</div>
                                <div class="stat-label">Avg P&L per Trade</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-value" id="maxLossPnl">$0.00</div>
                                <div class="stat-label">Max Loss</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div id="sessionAnalysis" class="analysis-content">
                <div class="analysis-grid">
                    <div class="analysis-card">
                        <h4>PRE-MARKET</h4>
                        <div class="analysis-stats">
                            <div class="stat-item">
                                <div class="stat-value" id="preMarketTrades">0</div>
                                <div class="stat-label">Total Trades</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-value" id="preMarketPnl">$0.00</div>
                                <div class="stat-label">Total P&L</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-value" id="preMarketWinRate">0%</div>
                                <div class="stat-label">Win Rate</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-value" id="preMarketAvgTime">0m</div>
                                <div class="stat-label">Avg Duration</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="analysis-card">
                        <h4>INTRADAY</h4>
                        <div class="analysis-stats">
                            <div class="stat-item">
                                <div class="stat-value" id="intradayTrades">0</div>
                                <div class="stat-label">Total Trades</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-value" id="intradayPnl">$0.00</div>
                                <div class="stat-label">Total P&L</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-value" id="intradayWinRate">0%</div>
                                <div class="stat-label">Win Rate</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-value" id="intradayAvgTime">0m</div>
                                <div class="stat-label">Avg Duration</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="analysis-card">
                        <h4>AFTER-HOUR</h4>
                        <div class="analysis-stats">
                            <div class="stat-item">
                                <div class="stat-value" id="afterHourTrades">0</div>
                                <div class="stat-label">Total Trades</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-value" id="afterHourPnl">$0.00</div>
                                <div class="stat-label">Total P&L</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-value" id="afterHourWinRate">0%</div>
                                <div class="stat-label">Win Rate</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-value" id="afterHourAvgTime">0m</div>
                                <div class="stat-label">Avg Duration</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div id="timeAnalysis" class="analysis-content">
                <div class="analysis-grid">
                    <div class="analysis-card">
                        <h4>Morning (6AM-12PM)</h4>
                        <div class="analysis-stats">
                            <div class="stat-item">
                                <div class="stat-value" id="morningTrades">0</div>
                                <div class="stat-label">Total Trades</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-value" id="morningPnl">$0.00</div>
                                <div class="stat-label">Total P&L</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-value" id="morningWinRate">0%</div>
                                <div class="stat-label">Win Rate</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="analysis-card">
                        <h4>Afternoon (12PM-6PM)</h4>
                        <div class="analysis-stats">
                            <div class="stat-item">
                                <div class="stat-value" id="afternoonTrades">0</div>
                                <div class="stat-label">Total Trades</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-value" id="afternoonPnl">$0.00</div>
                                <div class="stat-label">Total P&L</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-value" id="afternoonWinRate">0%</div>
                                <div class="stat-label">Win Rate</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="analysis-card">
                        <h4>Evening (6PM-12AM)</h4>
                        <div class="analysis-stats">
                            <div class="stat-item">
                                <div class="stat-value" id="eveningTrades">0</div>
                                <div class="stat-label">Total Trades</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-value" id="eveningPnl">$0.00</div>
                                <div class="stat-label">Total P&L</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-value" id="eveningWinRate">0%</div>
                                <div class="stat-label">Win Rate</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Trade Modal -->
    <div id="tradeModal" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="closeModal('tradeModal')">&times;</span>
            <h2>Manage Trades for Date: <span id="selectedDateDisplay" style="color: var(--color-highlight);"></span></h2>
            
            <input type="hidden" id="modalDate" name="modalDate"> 
            <input type="hidden" id="modalTradeId" name="modalTradeId"> 

            <!-- Trade Mode Toggle -->
            <div class="trade-mode-toggle-container">
                <span class="trade-mode-label active" id="detailedLabel" onclick="setTradeMode(false)">
                    <i class="fas fa-list-alt"></i> Detailed Trade
                </span>
                <label class="switch">
                    <input type="checkbox" id="tradeModeToggle" onchange="toggleTradeMode()">
                    <span class="slider"></span>
                </label>
                <span class="trade-mode-label inactive" id="simpleLabel" onclick="setTradeMode(true)">
                    <i class="fas fa-bolt"></i> Direct PnL
                </span>
            </div>

            <h3>Logged Trades</h3>
            <div id="dailyTradesList">
                <div class="trade-header">
                    <span>Symbol</span>
                    <span>Entry</span>
                    <span>Exit</span>
                    <span>Shares</span>
                    <span>Commission</span>
                    <span>PnL</span>
                    <span>Actions</span>
                </div>
            </div>

            <!-- No Trading Day Section -->
            <div style="text-align: center; margin: 20px 0; padding: 15px; background-color: var(--bg-day-label); border-radius: 8px;">
                <h4 style="margin: 0 0 10px 0; color: var(--text-secondary);">
                    <i class="fas fa-calendar-times"></i> Day Management
                </h4>
                <button type="button" id="markNoTradingDay" class="btn-secondary" style="background-color: var(--bg-inactive); color: var(--text-primary); border: 1px solid var(--border-cell); padding: 10px 20px; border-radius: 5px; cursor: pointer; transition: all 0.3s;">
                    <i class="fas fa-ban"></i> Mark as No Trading Day
                </button>
                <button type="button" id="unmarkNoTradingDay" class="btn-secondary" style="background-color: var(--color-highlight); color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; margin-left: 10px; transition: all 0.3s; display: none;">
                    <i class="fas fa-check"></i> Remove No Trading Mark
                </button>
                <p style="font-size: 0.8em; color: var(--text-secondary); margin: 10px 0 0 0;">
                    * Mark days when you didn't trade to track your trading frequency
                </p>
            </div>

            <h3 id="formTitle">Add New Trade</h3>
            
            <div id="detailedFormWrapper">
                <form id="tradeForm">
                    <div class="input-group">
                        <label for="symbol">Stock Symbol:</label>
                        <input type="text" id="symbol" placeholder="Ex: XYZ" required>
                    </div>
                    <div class="input-group">
                        <label for="entryPrice">Entry Price:</label>
                        <input type="number" id="entryPrice" step="0.01" required>
                    </div>
                    <div class="input-group">
                        <label for="exitPrice">Exit Price:</label>
                        <input type="number" id="exitPrice" step="0.01" required>
                    </div>
                    <div class="input-group">
                        <label for="shares">Number of Shares:</label>
                        <input type="number" id="shares" required>
                    </div>
                    <div class="input-group">
                        <label for="commission">Commission ($):</label>
                        <input type="number" id="commission" step="0.01" value="0.00">
                    </div>
                    
                    <!-- Enhanced Time Fields -->
                    <div class="input-group" style="grid-column: 1 / -1;">
                        <label style="margin-bottom: 10px; color: var(--color-highlight); font-weight: bold;">
                            <i class="fas fa-clock"></i> Trade Timing
                        </label>
                        <div class="time-input-group">
                            <div class="time-input-row">
                                <label for="entryTime">Entry Time:</label>
                                <input type="datetime-local" id="entryTime" required>
                            </div>
                            <div class="time-input-row">
                                <label for="exitTime">Exit Time:</label>
                                <input type="datetime-local" id="exitTime" required>
                            </div>
                            <div class="time-input-row">
                                <label for="tradingSession">Session:</label>
                                <select id="tradingSession" required style="flex: 1;">
                                    <option value="">Select Session</option>
                                    <option value="PRE_MARKET">PRE-MARKET</option>
                                    <option value="INTRADAY">INTRADAY</option>
                                    <option value="AFTER_HOUR">AFTER-HOUR</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <div class="input-group" style="grid-column: 1 / -1;">
                        <label for="notes">Notes:</label>
                        <textarea id="notes" placeholder="Add trade notes..." rows="3" style="padding: 10px; border: 1px solid var(--border-cell); background-color: var(--bg-inactive); color: var(--text-primary); border-radius: 4px; font-size: 1em; resize: vertical; min-height: 60px;"></textarea>
                    </div>
                    <div class="input-group" style="grid-column: 1 / -1;">
                        <label for="tradeImage">Trade Image:</label>
                        <input type="file" id="tradeImage" accept="image/*">
                        <small style="color: var(--text-secondary); margin-top: 5px;">*Upload screenshot of the trade</small>
                        <div id="tradeImagePreview" style="margin-top: 10px; display: none;">
                            <img id="previewImage" src="" alt="Trade Image Preview" style="max-width: 200px; max-height: 150px; border-radius: 4px; border: 1px solid var(--border-cell);">
                        </div>
                    </div>
                    
                    <button type="submit" id="submitButton">Log Trade</button>
                </form>
            </div>

            <div id="simpleFormWrapper" style="display: none;">
                <form id="simplePnLForm" style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                    <div class="input-group" style="grid-column: 1 / -1;">
                        <label for="directPnLAmount">P&L Amount ($):</label>
                        <input type="number" id="directPnLAmount" step="0.01" required>
                    </div>
                    <div class="input-group" style="grid-column: 1 / -1;">
                        <label for="simpleNotes">Notes:</label>
                        <textarea id="simpleNotes" placeholder="Add notes..." rows="2" style="padding: 10px; border: 1px solid var(--border-cell); background-color: var(--bg-inactive); color: var(--text-primary); border-radius: 4px; font-size: 1em; resize: vertical;"></textarea>
                    </div>
                    <button type="submit" id="submitSimplePnLButton">Log PnL</button>
                </form>
            </div>
            </div>
    </div>
    
    <!-- User Info Modal -->
    <div id="userInfoModal" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="closeModal('userInfoModal')">&times;</span>
            <h2><i class="fas fa-user-cog"></i> User Settings</h2>
            
            <form id="userInfoForm">
                <div class="input-group" style="grid-column: 1 / -1;">
                    <label for="newUserName">Update User Name:</label>
                    <input type="text" id="newUserName" placeholder="Your Name" required>
                </div>
                <div class="input-group" style="grid-column: 1 / -1;">
                    <label for="profileImageUpload">Upload Profile Image (Local):</label>
                    <input type="file" id="profileImageUpload" accept="image/*">
                    <small style="color: var(--text-secondary); margin-top: 5px;">*Image is stored locally in your browser.</small>
                </div>
                <button type="submit" id="saveUserInfoBtn">Save User Info</button>
            </form>
        </div>
    </div>
    
    <!-- Plan Modal -->
    <div id="planModal" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="closeModal('planModal')">&times;</span>
            <h2><i class="fas fa-chart-bar"></i> Set Trading Plan</h2>
            
            <form id="planForm">
                <div class="input-group" style="grid-column: 1 / -1;">
                    <label for="startingCapital">Starting Capital ($):</label>
                    <input type="number" id="startingCapital" step="0.01" required> </div>
                <div class="input-group" style="grid-column: 1 / -1;">
                    <label for="weeklyTargetGoal">Weekly Target Percentage (%):</label>
                    <input type="number" id="weeklyTargetGoal" step="0.01" min="0" max="100">
                </div>
                <div class="input-group" style="grid-column: 1 / -1;">
                    <label for="monthlyTargetGoal">Monthly Target Percentage (%):</label>
                    <input type="number" id="monthlyTargetGoal" step="0.01" min="0" max="100">
                </div>
                <div class="input-group" style="grid-column: 1 / -1;">
                    <label for="yearlyTargetGoal">Yearly Target Percentage (%):</label>
                    <input type="number" id="yearlyTargetGoal" step="0.01" min="0" max="1000">
                </div>
                <button type="submit" id="savePlanBtn">Save Plan</button>
            </form>
        </div>
    </div>

    <!-- Export Data Modal -->
    <div id="exportModal" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="closeModal('exportModal')">&times;</span>
            <h2><i class="fas fa-file-export"></i> Export Data</h2>
            
            <div class="export-controls">
                <div class="export-period-selector">
                    <label for="exportPeriod">Select Period:</label>
                    <select id="exportPeriod" onchange="toggleDateRange()">
                        <option value="all">All Data</option>
                        <option value="custom">Custom Date Range</option>
                        <option value="monthly">Current Month</option>
                        <option value="yearly">Current Year</option>
                    </select>
                </div>
                
                <div id="dateRangeSection" class="export-date-range" style="display: none;">
                    <div class="input-group">
                        <label for="startDate">Start Date:</label>
                        <input type="date" id="startDate">
                    </div>
                    <div class="input-group">
                        <label for="endDate">End Date:</label>
                        <input type="date" id="endDate">
                    </div>
                </div>
                
                <div class="export-options">
                    <label>Include:</label>
                    <div class="export-checkbox">
                        <input type="checkbox" id="includeTrades" checked>
                        <label for="includeTrades">Trades Data</label>
                    </div>
                    <div class="export-checkbox">
                        <input type="checkbox" id="includeAnalytics" checked>
                        <label for="includeAnalytics">Analytics Summary</label>
                    </div>
                    <div class="export-checkbox">
                        <input type="checkbox" id="includePlan" checked>
                        <label for="includePlan">Trading Plan</label>
                    </div>
                </div>
            </div>
            
            <div style="display: flex; gap: 10px; margin-top: 20px;">
                <button type="button" id="exportButton" class="btn-primary" onclick="exportToExcel()" style="flex: 1;">
                    <i class="fas fa-download"></i> Export to Excel
                </button>
                <button type="button" id="importButton" class="btn-secondary" onclick="openImportModal()" style="flex: 1; background-color: var(--color-profit); color: white; border: none;">
                    <i class="fas fa-upload"></i> Import Data
                </button>
            </div>
        </div>
    </div>

    <!-- Import Data Modal -->
    <div id="importModal" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="closeModal('importModal')">&times;</span>
            <h2><i class="fas fa-file-import"></i> Import Data</h2>
            
            <div class="import-controls">
                <div class="input-group" style="grid-column: 1 / -1;">
                    <label for="importFile">Select Excel File:</label>
                    <input type="file" id="importFile" accept=".xlsx, .xls" required>
                    <small style="color: var(--text-secondary); margin-top: 5px;">
                        * Supported formats: Excel (.xlsx, .xls)
                    </small>
                </div>
                
                <div class="import-options">
                    <label>Import Options:</label>
                    <div class="import-checkbox">
                        <input type="checkbox" id="importTrades" checked>
                        <label for="importTrades">Trades Data</label>
                    </div>
                    <div class="import-checkbox">
                        <input type="checkbox" id="importPlan">
                        <label for="importPlan">Trading Plan</label>
                    </div>
                    <div class="import-checkbox">
                        <input type="checkbox" id="importNoTradingDays">
                        <label for="importNoTradingDays">No Trading Days</label>
                    </div>
                    
                    <div class="import-strategy" style="margin-top: 15px;">
                        <label for="importStrategy">Import Strategy:</label>
                        <select id="importStrategy">
                            <option value="merge">Merge with existing data</option>
                            <option value="replace">Replace all data</option>
                            <option value="append">Append to existing data</option>
                        </select>
                    </div>
                </div>
                
                <div id="importPreview" style="display: none; margin-top: 15px;">
                    <h4>Preview:</h4>
                    <div id="previewContent" style="max-height: 200px; overflow-y: auto; background-color: var(--bg-day-label); padding: 10px; border-radius: 4px;"></div>
                </div>
            </div>
            
            <button type="button" id="confirmImportButton" class="btn-primary" onclick="importFromExcel()" style="width: 100%; margin-top: 20px;">
                <i class="fas fa-upload"></i> Import Data
            </button>
        </div>
    </div>

    <script>
        // ========== Global Variables ==========
        let trades = JSON.parse(localStorage.getItem('tradingJournal')) || [];
        let userInfo = JSON.parse(localStorage.getItem('journalUserInfo')) || { name: 'User Name', image: null };
        let tradingPlan = JSON.parse(localStorage.getItem('tradingPlan')) || { 
            capital: 10000, 
            weeklyTarget: 2, 
            monthlyTarget: 10, 
            yearlyTarget: 100, 
        };
        let noTradingDays = JSON.parse(localStorage.getItem('noTradingDays')) || [];
        let analyticsChart = null;

        // Initialize date variables
        const today = new Date();
        let currentDisplayDate = new Date(today.getFullYear(), today.getMonth(), 1);
        const todayDateString = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}-${String(today.getDate()).padStart(2, '0')}`;
        const holidayDays = [6, 0]; // Saturday and Sunday
        const monthNames = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];

        // ========== Data Saving Functions ==========
        function saveTrades() {
            localStorage.setItem('tradingJournal', JSON.stringify(trades));
        }

        function saveUserInfo() {
            localStorage.setItem('journalUserInfo', JSON.stringify(userInfo));
        }

        function saveTradingPlan() {
            localStorage.setItem('tradingPlan', JSON.stringify(tradingPlan));
        }

        function saveNoTradingDays() {
            localStorage.setItem('noTradingDays', JSON.stringify(noTradingDays));
        }

        // ========== Mobile Menu Functions ==========
        function toggleMobileMenu() {
            const mobileMenu = document.getElementById('mobileMenu');
            const hamburgerMenu = document.getElementById('hamburgerMenu');
            
            if (mobileMenu && hamburgerMenu) {
                mobileMenu.classList.toggle('active');
                hamburgerMenu.classList.toggle('active');
            }
        }

        function closeMobileMenu() {
            const mobileMenu = document.getElementById('mobileMenu');
            const hamburgerMenu = document.getElementById('hamburgerMenu');
            
            if (mobileMenu) mobileMenu.classList.remove('active');
            if (hamburgerMenu) hamburgerMenu.classList.remove('active');
        }

        // ========== Enhanced Mobile Calendar Functions ==========
        function renderMobileCalendar() {
            const mobileCalendarGrid = document.getElementById('mobileCalendarGrid');
            if (!mobileCalendarGrid) return;

            const year = currentDisplayDate.getFullYear();
            const month = currentDisplayDate.getMonth();
            const { dailyData } = aggregateDailyData(trades);
            
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            const firstDayOfMonth = new Date(year, month, 1).getDay();
            
            const dayNames = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
            
            mobileCalendarGrid.innerHTML = '';
            
            let currentWeek = [];
            let weekNumber = 0;
            
            // Add empty days at the beginning of the month
            for (let i = 0; i < firstDayOfMonth; i++) {
                currentWeek.push(null);
            }
            
            for (let day = 1; day <= daysInMonth; day++) {
                const dateString = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                const dayOfWeek = (firstDayOfMonth + day - 1) % 7;
                
                currentWeek.push({
                    day: day,
                    dateString: dateString,
                    dayOfWeek: dayOfWeek,
                    dayName: dayNames[dayOfWeek],
                    data: dailyData[dateString],
                    isNoTradingDay: noTradingDays.includes(dateString)
                });
                
                // When we reach the end of the week or end of the month
                if (currentWeek.length === 7 || day === daysInMonth) {
                    renderMobileWeek(currentWeek, weekNumber);
                    currentWeek = [];
                    weekNumber++;
                }
            }
        }

        function renderMobileWeek(weekDays, weekNumber) {
            const mobileCalendarGrid = document.getElementById('mobileCalendarGrid');
            if (!mobileCalendarGrid) return;
            
            const weekContainer = document.createElement('div');
            weekContainer.className = 'mobile-week';
            
            // First row (4 days)
            const firstRow = document.createElement('div');
            firstRow.className = 'mobile-week-row';
            
            // Second row (3 days + Total)
            const secondRow = document.createElement('div');
            secondRow.className = 'mobile-week-total-row';
            
            let weekTotal = 0;
            let tradeCountInWeek = 0;
            
            // Process first 4 days
            for (let i = 0; i < 4 && i < weekDays.length; i++) {
                const dayData = weekDays[i];
                if (dayData) {
                    const cell = createMobileCell(dayData);
                    firstRow.appendChild(cell);
                    
                    if (dayData.data) {
                        weekTotal += dayData.data.totalPnL;
                        tradeCountInWeek += dayData.data.tradeCount;
                    }
                } else {
                    const emptyCell = document.createElement('div');
                    emptyCell.className = 'mobile-calendar-cell empty-cell';
                    firstRow.appendChild(emptyCell);
                }
            }
            
            // Process remaining 3 days
            for (let i = 4; i < 7 && i < weekDays.length; i++) {
                const dayData = weekDays[i];
                if (dayData) {
                    const cell = createMobileCell(dayData);
                    secondRow.appendChild(cell);
                    
                    if (dayData.data) {
                        weekTotal += dayData.data.totalPnL;
                        tradeCountInWeek += dayData.data.tradeCount;
                    }
                } else {
                    const emptyCell = document.createElement('div');
                    emptyCell.className = 'mobile-calendar-cell empty-cell';
                    secondRow.appendChild(emptyCell);
                }
            }
            
            // Add total cell in second row
            const totalCell = createMobileTotalCell(weekTotal, tradeCountInWeek);
            secondRow.appendChild(totalCell);
            
            weekContainer.appendChild(firstRow);
            weekContainer.appendChild(secondRow);
            mobileCalendarGrid.appendChild(weekContainer);
        }

        function createMobileCell(dayData) {
            const cell = document.createElement('div');
            cell.className = 'mobile-calendar-cell';
            
            const dateString = dayData.dateString;
            const data = dayData.data;
            const isNoTradingDay = dayData.isNoTradingDay;
            
            const pnl = data ? data.totalPnL : 0;
            const count = data ? data.tradeCount : 0;
            
            if (dateString === todayDateString) {
                cell.classList.add('today-cell');
            }
            
            if (holidayDays.includes(dayData.dayOfWeek)) { 
                cell.classList.add('holiday');
            } else {
                cell.onclick = () => openTradeModal(dateString); 
            }

            if (isNoTradingDay) {
                cell.classList.add('no-trading-day');
            }

            let pnlClass = '';
            if (pnl > 0) {
                pnlClass = 'profit';
            } else if (pnl < 0) {
                pnlClass = 'loss';
            } else if (count === 0 && !holidayDays.includes(dayData.dayOfWeek) && !isNoTradingDay) {
                cell.classList.add('inactive-day'); 
            }

            cell.innerHTML = `
                <div class="mobile-day-name">${dayData.dayName}</div>
                <div class="mobile-day-number">
                    <span>${dayData.day}</span>
                    ${isNoTradingDay ? '<span class="no-trading-indicator" title="No Trading Day"><i class="fas fa-ban"></i></span>' : ''}
                    ${dateString === todayDateString ? '<span class="live-indicator">LIVE</span>' : ''}
                </div>
                <div class="mobile-daily-pnl ${pnlClass}">
                    ${isNoTradingDay ? 'No Trade' : pnl.toFixed(2) + ' $'}
                </div>
                <div class="mobile-trade-count">
                    ${isNoTradingDay ? 'No Trading' : count + ' trades'}
                </div>
            `;

            return cell;
        }

        function createMobileTotalCell(weekTotal, tradeCount) {
            const totalCell = document.createElement('div');
            totalCell.className = 'mobile-week-total-cell';
            
            let pnlClass = '';

            if (tradeCount > 0) {
                if (weekTotal > 0) {
                    pnlClass = 'profit';
                    totalCell.classList.add('weekly-profit');
                } else if (weekTotal < 0) {
                    pnlClass = 'loss';
                    totalCell.classList.add('weekly-loss');
                }
            } else {
                totalCell.classList.add('inactive-total');
            }

            totalCell.innerHTML = `
                <span style="font-size: 0.8em;">Weekly Total</span>
                <span class="mobile-daily-pnl ${pnlClass}" style="font-size: 0.9em;">${weekTotal.toFixed(2) + ' $'}</span>
                <span style="font-size: 0.6em; margin-top: 3px; color: var(--color-total-details);">${tradeCount} trades</span>
            `;
            
            return totalCell;
        }

        // ========== Theme Functions ==========
        function loadTheme() {
            const body = document.body;
            const savedTheme = localStorage.getItem('theme') || 'dark';
            const mobileThemeToggle = document.getElementById('mobileThemeToggle');
            const sidebarThemeToggle = document.getElementById('sidebarThemeToggle');
            
            if (savedTheme === 'light') {
                body.classList.add('light-mode');
                if (mobileThemeToggle) mobileThemeToggle.checked = true;
                if (sidebarThemeToggle) sidebarThemeToggle.checked = true;
            } else {
                body.classList.remove('light-mode');
                if (mobileThemeToggle) mobileThemeToggle.checked = false;
                if (sidebarThemeToggle) sidebarThemeToggle.checked = false;
            }
        }

        function toggleTheme() {
            const body = document.body;
            body.classList.toggle('light-mode');
            const currentTheme = body.classList.contains('light-mode') ? 'light' : 'dark';
            localStorage.setItem('theme', currentTheme);
            
            // Sync toggle states
            const mobileThemeToggle = document.getElementById('mobileThemeToggle');
            const sidebarThemeToggle = document.getElementById('sidebarThemeToggle');
            
            if (mobileThemeToggle) {
                mobileThemeToggle.checked = currentTheme === 'light';
            }
            if (sidebarThemeToggle) {
                sidebarThemeToggle.checked = currentTheme === 'light';
            }
        }

        // ========== Calendar Functions ==========
        function renderCalendar() {
            try {
                const monthYearElement = document.getElementById('currentMonthYear');
                const calendarGrid = document.querySelector('.calendar-grid');
                const mobileCalendarGrid = document.getElementById('mobileCalendarGrid');
                
                if (!monthYearElement) return;
                
                const year = currentDisplayDate.getFullYear();
                const month = currentDisplayDate.getMonth();
                
                monthYearElement.textContent = `${monthNames[month]} ${year}`;
                
                const { dailyData, totalMonthlyPnL } = aggregateDailyData(trades);
                
                // Update monthly total
                const monthlyPnlElement = document.getElementById('monthlyPnlSummary');
                if (monthlyPnlElement) {
                    monthlyPnlElement.textContent = '$' + totalMonthlyPnL.toFixed(2);
                    monthlyPnlElement.className = totalMonthlyPnL >= 0 ? 'profit' : 'loss';
                }

                // Check if mobile view
                const isMobile = window.innerWidth <= 768;
                
                if (isMobile) {
                    // Show mobile calendar and hide desktop calendar
                    if (mobileCalendarGrid) {
                        mobileCalendarGrid.style.display = 'flex';
                        renderMobileCalendar();
                    }
                    if (calendarGrid) {
                        calendarGrid.style.display = 'none';
                    }
                } else {
                    // Show desktop calendar and hide mobile calendar
                    if (calendarGrid) {
                        calendarGrid.style.display = 'grid';
                        renderDesktopCalendar(calendarGrid, dailyData, totalMonthlyPnL);
                    }
                    if (mobileCalendarGrid) {
                        mobileCalendarGrid.style.display = 'none';
                    }
                }
                
                updateDaysStatistics();
            } catch (error) {
                console.error('Error in renderCalendar:', error);
            }
        }

        function renderDesktopCalendar(calendarGrid, dailyData, totalMonthlyPnL) {
            const year = currentDisplayDate.getFullYear();
            const month = currentDisplayDate.getMonth();
            const weeklyTargetPercentage = tradingPlan.weeklyTarget;
            const capital = tradingPlan.capital;
            const fullWeeklyTargetAmount = capital * (weeklyTargetPercentage / 100);

            const today = new Date();
            const isCurrentMonth = (year === today.getFullYear() && month === today.getMonth());
            const goToTodayBtn = document.getElementById('goToTodayBtn');
            if (goToTodayBtn) {
                goToTodayBtn.style.display = isCurrentMonth ? 'none' : 'block';
            }

            // Clear current calendar
            while (calendarGrid.children.length > 8) {
                calendarGrid.removeChild(calendarGrid.lastChild);
            }
            
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            const firstDayOfMonth = new Date(year, month, 1).getDay();

            let dayCounter = 0;
            let weekTotal = 0;
            let tradeCountInWeek = 0;
            let availableTradingDays = 0;

            // Add empty cells for days before the first day of the month
            for (let i = 0; i < firstDayOfMonth; i++) {
                const emptyCell = document.createElement('div');
                emptyCell.className = 'calendar-cell empty-cell';
                calendarGrid.appendChild(emptyCell);
                dayCounter++;
            }
            
            // Add cells for each day of the month
            for (let day = 1; day <= daysInMonth; day++) {
                const dateString = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                const data = dailyData[dateString];
                const dayOfWeek = dayCounter % 7;
                const isNoTradingDay = noTradingDays.includes(dateString);
                
                const pnl = data ? data.totalPnL : 0;
                const count = data ? data.tradeCount : 0;
                
                weekTotal += pnl;
                tradeCountInWeek += count;
                
                if (dayOfWeek >= 1 && dayOfWeek <= 5) { 
                    availableTradingDays++; 
                }
                
                const cell = document.createElement('div');
                cell.className = 'calendar-cell';

                let liveIndicatorHTML = '';
                
                if (dateString === todayDateString) {
                     cell.classList.add('today-cell');
                     liveIndicatorHTML = '<span class="live-indicator">LIVE</span>';
                }
                
                if (holidayDays.includes(dayOfWeek)) { 
                     cell.classList.add('holiday');
                } else {
                    cell.onclick = () => openTradeModal(dateString);
                }

                if (isNoTradingDay) {
                    cell.classList.add('no-trading-day');
                }

                let pnlClass = '';
                if (pnl > 0) {
                    pnlClass = 'profit';
                } else if (pnl < 0) {
                    pnlClass = 'loss';
                } else if (count === 0 && !holidayDays.includes(dayOfWeek) && !isNoTradingDay) {
                    cell.classList.add('inactive-day');
                }

                cell.innerHTML = `
                    <div class="day-number">
                        <span>${day}</span>
                        ${isNoTradingDay ? '<span class="no-trading-indicator" title="No Trading Day"><i class="fas fa-ban"></i></span>' : ''}
                        ${liveIndicatorHTML}
                    </div>
                    <div class="daily-pnl ${pnlClass}">
                        ${isNoTradingDay ? 'No Trade' : pnl.toFixed(2) + ' $'}
                    </div>
                    <div class="trade-count">
                        ${isNoTradingDay ? 'No Trading' : count + ' trades'}
                    </div>
                `;

                calendarGrid.appendChild(cell);
                dayCounter++;

                // Add week total at the end of each week or month
                if (dayOfWeek === 6 || day === daysInMonth) {
                    addWeekTotal(weekTotal, tradeCountInWeek, fullWeeklyTargetAmount, availableTradingDays);
                    
                    weekTotal = 0;
                    tradeCountInWeek = 0;
                    availableTradingDays = 0;
                }
            }
            
            // Fill remaining cells to complete the grid
            const totalCells = calendarGrid.children.length;
            const cellsToAdd = (8 - (totalCells % 8)) % 8;
            
            for (let i = 0; i < cellsToAdd; i++) {
                const emptyCell = document.createElement('div');
                emptyCell.className = 'calendar-cell empty-cell';
                calendarGrid.appendChild(emptyCell);
            }
        }

        function addWeekTotal(pnl, count, fullWeeklyTargetAmount, availableDays) {
            try {
                const calendarGrid = document.querySelector('.calendar-grid');
                if (!calendarGrid) return;
                
                const totalCell = document.createElement('div');
                totalCell.className = 'week-total-cell';
                
                let pnlClass = '';
                let achievementHTML = '';

                if (count > 0) {
                    if (pnl > 0) {
                        pnlClass = 'profit';
                        totalCell.classList.add('weekly-profit');
                    } else if (pnl < 0) {
                        pnlClass = 'loss';
                        totalCell.classList.add('weekly-loss');
                    }
                } else {
                    totalCell.classList.add('inactive-total');
                }
                
                if (tradingPlan.weeklyTarget > 0 && fullWeeklyTargetAmount > 0) {
                    const targetPerDay = fullWeeklyTargetAmount / 5;
                    const adjustedWeeklyTargetAmount = availableDays * targetPerDay;

                    const achievementPct = (pnl / adjustedWeeklyTargetAmount) * 100;
                    const remainingAmount = adjustedWeeklyTargetAmount - pnl;
                    
                    let remainingDisplay = '';
                    let remainingClass = 'remaining-loss';

                    if (remainingAmount <= 0) {
                        remainingDisplay = 'Achieved';
                        remainingClass = 'achieved-text';
                    } else {
                        remainingDisplay = '$' + remainingAmount.toFixed(2);
                    }
                    
                    achievementHTML = `
                        <span style="font-size: 0.85em; font-weight: 500;">
                            Target: ${achievementPct.toFixed(1)}% 
                            <small>($${adjustedWeeklyTargetAmount.toFixed(2)})</small>
                        </span>
                        
                        <span style="font-size: 0.75em; margin-top: 2px; color: var(--color-remaining-accent);">
                            Remaining: <strong class="${remainingClass}">${remainingDisplay}</strong>
                        </span>
                        
                        <span style="font-size: 0.7em; margin-top: 2px; color: var(--color-total-details); opacity: 0.9;">
                            (${availableDays} trading days) 
                        </span>
                    `;
                } else {
                    achievementHTML = `<span style="font-size: 0.85em; color: var(--text-secondary); opacity: 0.8;">Target Not Set</span>`;
                }

                totalCell.innerHTML = `
                    <span>Weekly Total</span>
                    <span class="daily-pnl ${pnlClass}">${pnl.toFixed(2) + ' $'}</span>
                    ${achievementHTML}
                    <span style="font-size: 0.7em; margin-top: 3px; color: var(--color-total-details);">${count} trades</span>
                `;
                calendarGrid.appendChild(totalCell);
            } catch (error) {
                console.error('Error in addWeekTotal:', error);
            }
        }

        // ========== Other Calendar Functions ==========
        window.changeMonth = (delta) => {
            currentDisplayDate.setMonth(currentDisplayDate.getMonth() + delta);
            renderCalendar();
        };

        window.goToCurrentMonth = () => {
            const today = new Date();
            currentDisplayDate = new Date(today.getFullYear(), today.getMonth(), 1);
            renderCalendar();
        };

        // ========== PnL Calculation Functions ==========
        const getCurrentPeriodPnL = (period) => {
            const now = new Date();
            let totalPnL = 0;
            
            let startOfPeriod = new Date(now.getFullYear(), now.getMonth(), now.getDate());
            let endOfPeriod = new Date(now.getFullYear(), now.getMonth(), now.getDate());

            if (period === 'monthly') {
                startOfPeriod.setDate(1);
                endOfPeriod.setMonth(now.getMonth() + 1, 0);
            } else if (period === 'yearly') {
                startOfPeriod.setMonth(0, 1);
                endOfPeriod.setFullYear(now.getFullYear() + 1, 0, 0);
            } else if (period === 'weekly') {
                const day = startOfPeriod.getDay();
                startOfPeriod.setDate(startOfPeriod.getDate() - day);
                endOfPeriod = new Date(startOfPeriod);
                endOfPeriod.setDate(startOfPeriod.getDate() + 6);
            }
            
            startOfPeriod.setHours(0, 0, 0, 0);
            endOfPeriod.setHours(23, 59, 59, 999);

            trades.forEach(trade => {
                const tradeDate = new Date(trade.date + 'T00:00:00');
                
                if (tradeDate >= startOfPeriod && tradeDate <= endOfPeriod) {
                    totalPnL += calculatePnL(trade.entryPrice, trade.exitPrice, trade.shares, trade.directPnL, trade.commission || 0);
                }
            });
            return totalPnL;
        };

        const aggregateDailyData = (tradesList) => {
            const dailyData = {};
            let totalMonthlyPnL = 0;
            
            tradesList.forEach(trade => {
                const tradeDate = new Date(trade.date + 'T00:00:00');
                
                if (tradeDate.getFullYear() === currentDisplayDate.getFullYear() && 
                    tradeDate.getMonth() === currentDisplayDate.getMonth()) {
                        
                    const dateKey = trade.date;
                    const pnl = calculatePnL(trade.entryPrice, trade.exitPrice, trade.shares, trade.directPnL, trade.commission || 0);
                    totalMonthlyPnL += pnl;

                    if (!dailyData[dateKey]) {
                        dailyData[dateKey] = { totalPnL: 0, tradeCount: 0 };
                    }
                    
                    dailyData[dateKey].totalPnL += pnl;
                    dailyData[dateKey].tradeCount += 1;
                }
            });
            return { dailyData, totalMonthlyPnL };
        };

        function calculatePnL(entry, exit, shares, directPnL, commission = 0) {
            if (directPnL !== undefined && directPnL !== null) {
                return parseFloat(directPnL) - parseFloat(commission || 0);
            }
            return ((parseFloat(exit) - parseFloat(entry)) * parseInt(shares)) - parseFloat(commission || 0);
        }

        // ========== Plan Summary Functions ==========
        const renderPeriodGoal = (period, currentPnL, targetPercentage, capital) => {
            
            let achievementMessage = '';
            let achievementClass = 'in-progress';
            let disabledClass = '';

            const iconAchieved = '<i class="fas fa-check-circle"></i>';
            const iconNotAchieved = '<i class="fas fa-times-circle"></i>';
            const iconProgress = '<i class="fas fa-spinner fa-spin"></i>';
            const iconDisabled = '<i class="fas fa-minus-circle"></i>';
            
            let targetAmount = 0;
            let progressPercentage = 0;
            let progressWidth = 0;
            
            if (targetPercentage === 0) {
                achievementMessage = iconDisabled + ' Target Not Set.';
                achievementClass = 'not-set';
                disabledClass = 'disabled-goal';
                targetAmount = 0;
                progressWidth = 0;
            } else {
                targetAmount = capital * (targetPercentage / 100);
                progressPercentage = (currentPnL / targetAmount) * 100;
                progressWidth = Math.min(100, Math.max(0, progressPercentage));
                
                if (currentPnL >= targetAmount) {
                    achievementMessage = iconAchieved + ' Target Achieved!';
                    achievementClass = 'achieved';
                } else if (currentPnL >= 0) {
                    achievementMessage = iconProgress + ' In Progress...';
                    achievementClass = 'in-progress';
                } else {
                    achievementMessage = iconNotAchieved + ' PnL is Negative.';
                    achievementClass = 'not-achieved';
                }
            }
            
            const formattedPnL = currentPnL.toFixed(2);
            const pnlClass = currentPnL >= 0 ? 'profit' : 'loss';
            const periodTitle = period.charAt(0).toUpperCase() + period.slice(1);
            
            const progressText = progressPercentage.toFixed(1) + '%';

            return `
                <div class="period-summary-item ${period} ${disabledClass}">
                    <h4>${periodTitle} Goal</h4>
                    
                    <div class="pnl-and-goal-row">
                        <p class="goal-pct">${targetPercentage.toFixed(1)}% <small>($${targetAmount.toFixed(2)})</small></p>
                        <p class="${pnlClass}">Current PnL: $${formattedPnL}</p>
                    </div>

                    <div class="progress-bar-container">
                        <span class="progress-text">${progressText}</span>
                        <div class="progress-bar" style="width: ${progressWidth}%;">
                             <div class="progress-bar-inner"></div>
                        </div>
                    </div>
                    
                    <div class="achievement-status ${achievementClass}">
                        ${achievementMessage}
                    </div>
                </div>
            `;
        };

        const renderPlanSummary = () => {
            try {
                const planSummaryElement = document.getElementById('planSummary');
                if (!planSummaryElement) return;

                const capital = tradingPlan.capital;
                
                const currentWeeklyPnL = getCurrentPeriodPnL('weekly');
                const currentMonthlyPnL = getCurrentPeriodPnL('monthly');
                const currentYearlyPnL = getCurrentPeriodPnL('yearly');

                const weeklySummary = renderPeriodGoal('weekly', currentWeeklyPnL, tradingPlan.weeklyTarget, capital);
                const monthlySummary = renderPeriodGoal('monthly', currentMonthlyPnL, tradingPlan.monthlyTarget, capital);
                const yearlySummary = renderPeriodGoal('yearly', currentYearlyPnL, tradingPlan.yearlyTarget, capital);
                
                planSummaryElement.style.display = 'flex';
                planSummaryElement.innerHTML = `
                    <div class="plan-item general-capital">
                        <h4>Starting Capital</h4>
                        <p>$${capital.toFixed(2)}</p>
                    </div>
                    <div class="goals-container">
                        ${weeklySummary}
                        ${monthlySummary}
                        ${yearlySummary}
                    </div>
                `;
            } catch (error) {
                console.error('Error in renderPlanSummary:', error);
            }
        };

        // ========== Modal Functions ==========
        window.openTradeModal = (dateString) => {
            try {
                const [y, m, d] = dateString.split('-');
                const selectedDateDisplay = document.getElementById('selectedDateDisplay');
                if (selectedDateDisplay) selectedDateDisplay.textContent = `${y}/${m}/${d}`;
                
                const modalDateInput = document.getElementById('modalDate');
                const modalTradeIdInput = document.getElementById('modalTradeId');
                
                if (modalDateInput) modalDateInput.value = dateString;
                if (modalTradeIdInput) modalTradeIdInput.value = '';
                
                const tradeModeToggle = document.getElementById('tradeModeToggle');
                if (tradeModeToggle) {
                    tradeModeToggle.checked = false;
                    toggleTradeMode();
                }

                // Update No Trading Day buttons
                updateNoTradingButtons(dateString);

                // Set default time
                const now = new Date();
                const currentDate = now.toISOString().slice(0, 10);
                
                const entryTimeInput = document.getElementById('entryTime');
                const exitTimeInput = document.getElementById('exitTime');
                const tradingSessionSelect = document.getElementById('tradingSession');
                
                if (dateString === currentDate) {
                    const currentTime = now.toTimeString().slice(0, 5);
                    const defaultEntryTime = `${dateString}T${currentTime}`;
                    const exitTime = new Date(now.getTime() + 30 * 60000);
                    const defaultExitTime = `${dateString}T${exitTime.toTimeString().slice(0, 5)}`;
                    
                    if (entryTimeInput) entryTimeInput.value = defaultEntryTime;
                    if (exitTimeInput) exitTimeInput.value = defaultExitTime;
                } else {
                    const defaultEntryTime = `${dateString}T10:00`;
                    const defaultExitTime = `${dateString}T10:30`;
                    
                    if (entryTimeInput) entryTimeInput.value = defaultEntryTime;
                    if (exitTimeInput) exitTimeInput.value = defaultExitTime;
                }
                
                if (tradingSessionSelect) tradingSessionSelect.value = 'INTRADAY';

                updateTradesList(dateString);
                const tradeModal = document.getElementById('tradeModal');
                if (tradeModal) tradeModal.style.display = 'flex';
            } catch (error) {
                console.error('Error in openTradeModal:', error);
            }
        };

        function updateTradesList(dateString) {
            try {
                const dailyTrades = trades.filter(t => t.date === dateString);
                const dailyTradesListElement = document.getElementById('dailyTradesList');
                
                if (!dailyTradesListElement) return;
                
                let tradesListHTML = `
                    <div class="trade-header">
                        <span>Symbol</span>
                        <span>Entry</span>
                        <span>Exit</span>
                        <span>Shares</span>
                        <span>Commission</span>
                        <span>PnL</span>
                        <span>Actions</span>
                    </div>
                `;

                if (dailyTrades.length > 0) {
                    dailyTrades.forEach(trade => {
                        const pnl = calculatePnL(trade.entryPrice, trade.exitPrice, trade.shares, trade.directPnL, trade.commission || 0);
                        const pnlClass = pnl >= 0 ? 'profit' : 'loss';
                        
                        const isSimple = trade.symbol === 'DIRECT_PNL';

                        tradesListHTML += `
                            <div class="daily-trade-item">
                                <span>${isSimple ? 'PnL' : trade.symbol}</span>
                                <span>${isSimple ? 'N/A' : trade.entryPrice.toFixed(2)}</span>
                                <span>${isSimple ? 'N/A' : trade.exitPrice.toFixed(2)}</span>
                                <span>${isSimple ? 'N/A' : trade.shares}</span>
                                <span>${isSimple ? 'N/A' : '$' + (trade.commission || 0).toFixed(2)}</span>
                                <span class="${pnlClass}">${pnl.toFixed(2) + ' $'}</span>
                                <div style="display: flex; gap: 5px;">
                                    <button class="edit-btn" onclick="editTrade('${trade.id}', '${dateString}')">Edit</button>
                                    <button class="delete-btn" onclick="deleteTrade('${trade.id}', '${dateString}')">Delete</button>
                                </div>
                            </div>
                        `;
                    });
                } else {
                    tradesListHTML += '<p style="text-align: center; color: var(--text-secondary); font-size: 0.9em; grid-column: 1 / -1; padding: 15px;">No trades logged for this day.</p>';
                }

                dailyTradesListElement.innerHTML = tradesListHTML;
            } catch (error) {
                console.error('Error in updateTradesList:', error);
            }
        }

        window.openUserInfoModal = () => {
            try {
                const newUserNameInput = document.getElementById('newUserName');
                if (newUserNameInput) newUserNameInput.value = userInfo.name;
                const userInfoModal = document.getElementById('userInfoModal');
                if (userInfoModal) userInfoModal.style.display = 'flex';
            } catch (error) {
                console.error('Error in openUserInfoModal:', error);
            }
        };

        window.openPlanModal = () => {
            try {
                const startingCapitalInput = document.getElementById('startingCapital');
                const weeklyTargetGoalInput = document.getElementById('weeklyTargetGoal');
                const monthlyTargetGoalInput = document.getElementById('monthlyTargetGoal');
                const yearlyTargetGoalInput = document.getElementById('yearlyTargetGoal');
                
                if (startingCapitalInput) startingCapitalInput.value = tradingPlan.capital;
                if (weeklyTargetGoalInput) weeklyTargetGoalInput.value = tradingPlan.weeklyTarget;
                if (monthlyTargetGoalInput) monthlyTargetGoalInput.value = tradingPlan.monthlyTarget;
                if (yearlyTargetGoalInput) yearlyTargetGoalInput.value = tradingPlan.yearlyTarget;
                
                const planModal = document.getElementById('planModal');
                if (planModal) planModal.style.display = 'flex';
            } catch (error) {
                console.error('Error in openPlanModal:', error);
            }
        };

        window.openTimeAnalysisModal = function() {
            updateTimeAnalysis();
            document.getElementById('timeAnalysisModal').style.display = 'flex';
        };

        window.openExportModal = () => {
            try {
                const today = new Date();
                const firstDayOfMonth = new Date(today.getFullYear(), today.getMonth(), 1);
                
                const startDate = document.getElementById('startDate');
                const endDate = document.getElementById('endDate');
                if (startDate) startDate.value = firstDayOfMonth.toISOString().split('T')[0];
                if (endDate) endDate.value = today.toISOString().split('T')[0];
                
                const exportModal = document.getElementById('exportModal');
                if (exportModal) exportModal.style.display = 'flex';
            } catch (error) {
                console.error('Error in openExportModal:', error);
            }
        };

        window.closeModal = (id) => {
            const modal = document.getElementById(id);
            if (modal) modal.style.display = 'none';
            
            if (id === 'tradeModal') {
                const form = document.getElementById('tradeForm');
                const simplePnLForm = document.getElementById('simplePnLForm');
                const modalTradeIdInput = document.getElementById('modalTradeId');
                
                if (form) form.reset();
                if (simplePnLForm) simplePnLForm.reset();
                if (modalTradeIdInput) modalTradeIdInput.value = '';
                const tradeImagePreview = document.getElementById('tradeImagePreview');
                const tradeImage = document.getElementById('tradeImage');
                if (tradeImagePreview) tradeImagePreview.style.display = 'none';
                if (tradeImage) tradeImage.value = '';
            }
            if (id === 'userInfoModal') {
                const userInfoForm = document.getElementById('userInfoForm');
                const profileImageUpload = document.getElementById('profileImageUpload');
                if (userInfoForm) userInfoForm.reset();
                if (profileImageUpload) profileImageUpload.value = '';
            }
            if (id === 'planModal') {
                const planForm = document.getElementById('planForm');
                if (planForm) planForm.reset();
            }
            if (id === 'exportModal') {
                const exportPeriod = document.getElementById('exportPeriod');
                const dateRangeSection = document.getElementById('dateRangeSection');
                const includeTrades = document.getElementById('includeTrades');
                const includeAnalytics = document.getElementById('includeAnalytics');
                const includePlan = document.getElementById('includePlan');
                
                if (exportPeriod) exportPeriod.value = 'all';
                if (dateRangeSection) dateRangeSection.style.display = 'none';
                if (includeTrades) includeTrades.checked = true;
                if (includeAnalytics) includeAnalytics.checked = true;
                if (includePlan) includePlan.checked = true;
            }
            if (id === 'importModal') {
                const importFile = document.getElementById('importFile');
                const importPreview = document.getElementById('importPreview');
                if (importFile) importFile.value = '';
                if (importPreview) importPreview.style.display = 'none';
            }
        };

        window.onclick = function(event) {
            if (event.target.classList.contains('modal')) {
                closeModal(event.target.id);
            }
        }

        // ========== Trade Mode Toggle Functions ==========
        window.setTradeMode = (isSimpleMode) => {
            const tradeModeToggle = document.getElementById('tradeModeToggle');
            if (tradeModeToggle) tradeModeToggle.checked = isSimpleMode;
            toggleTradeMode();
        };

        window.toggleTradeMode = () => {
            const tradeModeToggle = document.getElementById('tradeModeToggle');
            const detailedFormWrapper = document.getElementById('detailedFormWrapper');
            const simpleFormWrapper = document.getElementById('simpleFormWrapper');
            const detailedLabel = document.getElementById('detailedLabel');
            const simpleLabel = document.getElementById('simpleLabel');
            const formTitle = document.getElementById('formTitle');
            const submitButton = document.getElementById('submitButton');
            
            if (!tradeModeToggle || !detailedFormWrapper || !simpleFormWrapper) return;
            
            const isSimpleMode = tradeModeToggle.checked;
            
            detailedFormWrapper.style.display = isSimpleMode ? 'none' : 'block';
            simpleFormWrapper.style.display = isSimpleMode ? 'grid' : 'none';
            
            if (isSimpleMode) {
                if (detailedLabel) {
                    detailedLabel.classList.remove('active');
                    detailedLabel.classList.add('inactive');
                }
                if (simpleLabel) {
                    simpleLabel.classList.remove('inactive');
                    simpleLabel.classList.add('active');
                }
            } else {
                if (detailedLabel) {
                    detailedLabel.classList.remove('inactive');
                    detailedLabel.classList.add('active');
                }
                if (simpleLabel) {
                    simpleLabel.classList.remove('active');
                    simpleLabel.classList.add('inactive');
                }
            }
            
            const form = document.getElementById('tradeForm');
            const simplePnLForm = document.getElementById('simplePnLForm');
            const modalTradeIdInput = document.getElementById('modalTradeId');
            
            if (form) form.reset();
            if (simplePnLForm) simplePnLForm.reset();
            if (modalTradeIdInput) modalTradeIdInput.value = '';
            
            const tradeImagePreview = document.getElementById('tradeImagePreview');
            const tradeImage = document.getElementById('tradeImage');
            if (tradeImagePreview) tradeImagePreview.style.display = 'none';
            if (tradeImage) tradeImage.value = '';
            
            if (formTitle) formTitle.textContent = isSimpleMode ? 'Add Direct PnL' : 'Add New Trade';
            if (submitButton) submitButton.textContent = isSimpleMode ? 'Log PnL' : 'Log Trade';
        };

        // ========== Trade Management Functions ==========
        window.deleteTrade = async (tradeId, dateString) => {
            if (!confirm('Are you sure you want to delete this trade?')) return;

            trades = trades.filter(t => t.id != tradeId);
            saveTrades();
            
            renderCalendar();
            renderPlanSummary();
            updateTradesList(dateString);
        };

        window.editTrade = (tradeId, dateString) => {
            try {
                const tradeToEdit = trades.find(t => t.id == tradeId);
                if (!tradeToEdit) return;
                
                if (tradeToEdit.symbol === 'DIRECT_PNL') {
                    const tradeModeToggle = document.getElementById('tradeModeToggle');
                    if (tradeModeToggle) {
                        tradeModeToggle.checked = true;
                        toggleTradeMode();
                    }

                    const modalTradeIdInput = document.getElementById('modalTradeId');
                    const directPnLAmountInput = document.getElementById('directPnLAmount');
                    const simpleNotes = document.getElementById('simpleNotes');
                    const formTitle = document.getElementById('formTitle');
                    const submitSimplePnLButton = document.getElementById('submitSimplePnLButton');

                    if (modalTradeIdInput) modalTradeIdInput.value = tradeId;
                    if (directPnLAmountInput) directPnLAmountInput.value = tradeToEdit.directPnL;
                    if (simpleNotes) simpleNotes.value = tradeToEdit.notes || '';

                    if (formTitle) formTitle.textContent = 'Edit Direct PnL';
                    if (submitSimplePnLButton) submitSimplePnLButton.textContent = 'Update PnL';
                } else {
                    const tradeModeToggle = document.getElementById('tradeModeToggle');
                    if (tradeModeToggle) {
                        tradeModeToggle.checked = false;
                        toggleTradeMode();
                    }

                    const modalTradeIdInput = document.getElementById('modalTradeId');
                    const symbolInput = document.getElementById('symbol');
                    const entryPriceInput = document.getElementById('entryPrice');
                    const exitPriceInput = document.getElementById('exitPrice');
                    const sharesInput = document.getElementById('shares');
                    const commissionInput = document.getElementById('commission');
                    const notesInput = document.getElementById('notes');
                    const entryTimeInput = document.getElementById('entryTime');
                    const exitTimeInput = document.getElementById('exitTime');
                    const tradingSessionSelect = document.getElementById('tradingSession');
                    const previewContainer = document.getElementById('tradeImagePreview');
                    const previewImage = document.getElementById('previewImage');
                    const formTitle = document.getElementById('formTitle');
                    const submitButton = document.getElementById('submitButton');

                    if (modalTradeIdInput) modalTradeIdInput.value = tradeId;
                    if (symbolInput) symbolInput.value = tradeToEdit.symbol;
                    if (entryPriceInput) entryPriceInput.value = tradeToEdit.entryPrice;
                    if (exitPriceInput) exitPriceInput.value = tradeToEdit.exitPrice;
                    if (sharesInput) sharesInput.value = tradeToEdit.shares;
                    if (commissionInput) commissionInput.value = tradeToEdit.commission || 0;
                    if (notesInput) notesInput.value = tradeToEdit.notes || '';
                    
                    if (tradeToEdit.entryDateTime && entryTimeInput) {
                        entryTimeInput.value = tradeToEdit.entryDateTime.replace(' ', 'T').substring(0, 16);
                    }
                    if (tradeToEdit.exitDateTime && exitTimeInput) {
                        exitTimeInput.value = tradeToEdit.exitDateTime.replace(' ', 'T').substring(0, 16);
                    }
                    if (tradeToEdit.tradingSession && tradingSessionSelect) {
                        tradingSessionSelect.value = tradeToEdit.tradingSession;
                    }
                    
                    if (tradeToEdit.tradeImage) {
                        if (previewImage) previewImage.src = tradeToEdit.tradeImage;
                        if (previewContainer) previewContainer.style.display = 'block';
                    } else {
                        if (previewContainer) previewContainer.style.display = 'none';
                    }

                    if (formTitle) formTitle.textContent = 'Edit Current Trade';
                    if (submitButton) submitButton.textContent = 'Update Trade';
                }
            } catch (error) {
                console.error('Error in editTrade:', error);
            }
        };

        // ========== No Trading Days Management ==========
        function updateNoTradingButtons(dateString) {
            const markBtn = document.getElementById('markNoTradingDay');
            const unmarkBtn = document.getElementById('unmarkNoTradingDay');
            
            if (!markBtn || !unmarkBtn) return;
            
            const isNoTradingDay = noTradingDays.includes(dateString);
            
            if (isNoTradingDay) {
                markBtn.style.display = 'none';
                unmarkBtn.style.display = 'inline-block';
            } else {
                markBtn.style.display = 'inline-block';
                unmarkBtn.style.display = 'none';
            }
        }

        window.markAsNoTradingDay = async function() {
            const dateString = document.getElementById('modalDate')?.value;
            if (!dateString) return;
            
            if (!noTradingDays.includes(dateString)) {
                noTradingDays.push(dateString);
                saveNoTradingDays();
                updateNoTradingButtons(dateString);
                renderCalendar();
                updateDaysStatistics();
                alert('Day marked as no trading day');
            }
        };

        window.unmarkNoTradingDay = async function() {
            const dateString = document.getElementById('modalDate')?.value;
            if (!dateString) return;
            
            noTradingDays = noTradingDays.filter(day => day !== dateString);
            saveNoTradingDays();
            updateNoTradingButtons(dateString);
            renderCalendar();
            updateDaysStatistics();
            alert('No trading mark removed');
        };

        // ========== Days Statistics Function ==========
        function updateDaysStatistics() {
            try {
                const now = new Date();
                const currentMonth = now.getMonth();
                const currentYear = now.getFullYear();
                
                const totalMonthDays = new Date(currentYear, currentMonth + 1, 0).getDate();
                
                let holidayDaysCount = 0;
                for (let day = 1; day <= totalMonthDays; day++) {
                    const date = new Date(currentYear, currentMonth, day);
                    const dayOfWeek = date.getDay();
                    if (dayOfWeek === 0 || dayOfWeek === 6) {
                        holidayDaysCount++;
                    }
                }
                
                const tradingDaysSet = new Set();
                
                trades.forEach(trade => {
                    const tradeDate = new Date(trade.date + 'T00:00:00');
                    if (tradeDate.getMonth() === currentMonth && tradeDate.getFullYear() === currentYear) {
                        tradingDaysSet.add(trade.date);
                    }
                });
                
                const tradingDays = tradingDaysSet.size;
                
                // Calculate no trading days
                const noTradingDaysCount = noTradingDays.filter(date => {
                    const dateObj = new Date(date + 'T00:00:00');
                    return dateObj.getMonth() === currentMonth && dateObj.getFullYear() === currentYear;
                }).length;
                
                const today = new Date();
                let remainingTradingDays = 0;
                
                for (let day = today.getDate() + 1; day <= totalMonthDays; day++) {
                    const date = new Date(currentYear, currentMonth, day);
                    const dayOfWeek = date.getDay();
                    if (dayOfWeek !== 0 && dayOfWeek !== 6) {
                        remainingTradingDays++;
                    }
                }
                
                const tradingDaysElement = document.getElementById('tradingDays');
                const noTradingDaysElement = document.getElementById('noTradingDays');
                const holidayDaysElement = document.getElementById('holidayDays');
                const remainingDaysElement = document.getElementById('remainingDays');
                const totalMonthDaysElement = document.getElementById('totalMonthDays');
                
                if (tradingDaysElement) tradingDaysElement.textContent = tradingDays;
                if (noTradingDaysElement) noTradingDaysElement.textContent = noTradingDaysCount;
                if (holidayDaysElement) holidayDaysElement.textContent = holidayDaysCount;
                if (remainingDaysElement) remainingDaysElement.textContent = remainingTradingDays;
                if (totalMonthDaysElement) totalMonthDaysElement.textContent = totalMonthDays;
                
            } catch (error) {
                console.log('Error in updateDaysStatistics:', error);
            }
        }

        // ========== Analytics Functions ==========
        function initializeAnalytics() {
            updateAnalyticsChart();
        }

        function updateAnalyticsChart() {
            const period = document.getElementById('analyticsPeriod');
            const metric = document.getElementById('analyticsMetric');
            
            if (!period || !metric) return;
            
            // Destroy old chart if exists
            if (analyticsChart) {
                analyticsChart.destroy();
                analyticsChart = null;
            }
            
            const data = calculateAnalyticsData(period.value, metric.value);
            const ctx = document.getElementById('analyticsChart');
            if (!ctx) return;
            
            analyticsChart = new Chart(ctx.getContext('2d'), {
                type: 'bar',
                data: {
                    labels: data.labels,
                    datasets: [{
                        label: getMetricLabel(metric.value),
                        data: data.values,
                        backgroundColor: function(context) {
                            const value = context.dataset.data[context.dataIndex];
                            if (metric.value === 'pnl') {
                                return value >= 0 ? 'rgba(76, 175, 80, 0.7)' : 'rgba(244, 67, 54, 0.7)';
                            } else if (metric.value === 'days') {
                                return 'rgba(0, 188, 212, 0.7)';
                            } else {
                                return 'rgba(255, 193, 7, 0.7)';
                            }
                        },
                        borderColor: function(context) {
                            const value = context.dataset.data[context.dataIndex];
                            if (metric.value === 'pnl') {
                                return value >= 0 ? 'rgba(76, 175, 80, 1)' : 'rgba(244, 67, 54, 1)';
                            } else if (metric.value === 'days') {
                                return 'rgba(0, 188, 212, 1)';
                            } else {
                                return 'rgba(255, 193, 7, 1)';
                            }
                        },
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    if (metric.value === 'pnl') {
                                        return '$' + value.toFixed(2);
                                    } else if (metric.value === 'winRate') {
                                        return value + '%';
                                    } else {
                                        return value;
                                    }
                                }
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    if (metric.value === 'pnl') {
                                        return '$' + context.parsed.y.toFixed(2);
                                    } else if (metric.value === 'winRate') {
                                        return context.parsed.y.toFixed(1) + '%';
                                    } else {
                                        return context.parsed.y;
                                    }
                                }
                            }
                        }
                    }
                }
            });
            
            updateAnalyticsSummary();
        }

        function getMetricLabel(metric) {
            switch(metric) {
                case 'pnl': return 'Profit & Loss';
                case 'trades': return 'Number of Trades';
                case 'winRate': return 'Win Rate (%)';
                case 'days': return 'Trading Days';
                default: return 'Data';
            }
        }

        function calculateAnalyticsData(period, metric) {
            const now = new Date();
            const labels = [];
            const values = [];
            
            let periodsCount = 0;
            
            switch(period) {
                case 'weekly':
                    periodsCount = 8;
                    break;
                case 'monthly':
                    periodsCount = 12;
                    break;
                case 'quarterly':
                    periodsCount = 4;
                    break;
                case 'yearly':
                    periodsCount = 5;
                    break;
                case 'daily':
                    periodsCount = 30;
                    break;
            }
            
            for (let i = periodsCount - 1; i >= 0; i--) {
                const periodData = getPeriodData(period, i, metric);
                labels.push(periodData.label);
                values.push(periodData.value);
            }
            
            return { labels, values };
        }

        function getPeriodData(period, offset, metric) {
            const now = new Date();
            let startDate, endDate, label;
            
            switch(period) {
                case 'weekly':
                    startDate = new Date(now);
                    startDate.setDate(now.getDate() - offset * 7);
                    startDate.setDate(startDate.getDate() - startDate.getDay());
                    endDate = new Date(startDate);
                    endDate.setDate(startDate.getDate() + 6);
                    label = startDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                    break;
                case 'monthly':
                    startDate = new Date(now.getFullYear(), now.getMonth() - offset, 1);
                    endDate = new Date(now.getFullYear(), now.getMonth() - offset + 1, 0);
                    label = startDate.toLocaleDateString('en-US', { month: 'short', year: 'numeric' });
                    break;
                case 'quarterly':
                    const quarterStartMonth = Math.floor((now.getMonth() - offset * 3) / 3) * 3;
                    startDate = new Date(now.getFullYear(), quarterStartMonth, 1);
                    endDate = new Date(now.getFullYear(), quarterStartMonth + 3, 0);
                    const quarter = Math.floor(quarterStartMonth / 3) + 1;
                    label = `Q${quarter} ${startDate.getFullYear()}`;
                    break;
                case 'yearly':
                    startDate = new Date(now.getFullYear() - offset, 0, 1);
                    endDate = new Date(now.getFullYear() - offset, 11, 31);
                    label = startDate.getFullYear().toString();
                    break;
                case 'daily':
                    startDate = new Date(now);
                    startDate.setDate(now.getDate() - offset);
                    endDate = new Date(startDate);
                    label = startDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                    break;
            }
            
            let value = 0;
            let totalTrades = 0;
            let winningTrades = 0;
            let tradingDays = 0;
            
            const filteredTrades = trades.filter(trade => {
                const tradeDate = new Date(trade.date + 'T00:00:00');
                return tradeDate >= startDate && tradeDate <= endDate;
            });
            
            switch(metric) {
                case 'pnl':
                    filteredTrades.forEach(trade => {
                        const pnl = calculatePnL(trade.entryPrice, trade.exitPrice, trade.shares, trade.directPnL, trade.commission || 0);
                        value += pnl;
                    });
                    break;
                case 'trades':
                    value = filteredTrades.length;
                    break;
                case 'winRate':
                    filteredTrades.forEach(trade => {
                        const pnl = calculatePnL(trade.entryPrice, trade.exitPrice, trade.shares, trade.directPnL, trade.commission || 0);
                        if (pnl > 0) winningTrades++;
                    });
                    value = filteredTrades.length > 0 ? (winningTrades / filteredTrades.length) * 100 : 0;
                    break;
                case 'days':
                    // Calculate trading days
                    const tradingDaysSet = new Set();
                    filteredTrades.forEach(trade => {
                        tradingDaysSet.add(trade.date);
                    });
                    value = tradingDaysSet.size;
                    break;
            }
            
            return { label, value };
        }

        function updateAnalyticsSummary() {
            let totalProfit = 0;
            let totalLoss = 0;
            let winningTrades = 0;
            let totalTrades = trades.length;
            
            trades.forEach(trade => {
                const pnl = calculatePnL(trade.entryPrice, trade.exitPrice, trade.shares, trade.directPnL, trade.commission || 0);
                if (pnl > 0) {
                    totalProfit += pnl;
                    winningTrades++;
                } else {
                    totalLoss += Math.abs(pnl);
                }
            });
            
            const netPnl = totalProfit - totalLoss;
            const winRate = totalTrades > 0 ? (winningTrades / totalTrades) * 100 : 0;
            
            const totalProfitElement = document.getElementById('totalProfit');
            const totalLossElement = document.getElementById('totalLoss');
            const netPnlElement = document.getElementById('netPnl');
            const winRateElement = document.getElementById('winRate');
            
            if (totalProfitElement) totalProfitElement.textContent = '$' + totalProfit.toFixed(2);
            if (totalLossElement) totalLossElement.textContent = '$' + totalLoss.toFixed(2);
            if (netPnlElement) {
                netPnlElement.textContent = '$' + netPnl.toFixed(2);
                netPnlElement.className = netPnl >= 0 ? 'profit' : 'loss';
            }
            if (winRateElement) winRateElement.textContent = winRate.toFixed(1) + '%';
        }

        // ========== Time Analysis Functions ==========
        function calculateTradeDuration(entryDateTime, exitDateTime) {
            if (!entryDateTime || !exitDateTime) return 30;
            try {
                const entry = new Date(entryDateTime);
                const exit = new Date(exitDateTime);
                return Math.round((exit - entry) / (1000 * 60)); // Duration in minutes
            } catch (error) {
                return 30;
            }
        }

        function determineTimeCategory(entryDateTime) {
            if (!entryDateTime) return 'INTRADAY';
            try {
                const entry = new Date(entryDateTime);
                const hour = entry.getHours();
                
                if (hour >= 6 && hour < 12) return 'MORNING';
                if (hour >= 12 && hour < 18) return 'AFTERNOON';
                return 'EVENING';
            } catch (error) {
                return 'INTRADAY';
            }
        }

        function analyzeWinningTrades() {
            const winningTrades = trades.filter(trade => {
                const pnl = calculatePnL(trade.entryPrice, trade.exitPrice, trade.shares, trade.directPnL, trade.commission || 0);
                return pnl > 0;
            });
            
            const losingTrades = trades.filter(trade => {
                const pnl = calculatePnL(trade.entryPrice, trade.exitPrice, trade.shares, trade.directPnL, trade.commission || 0);
                return pnl < 0;
            });
            
            return { winningTrades, losingTrades };
        }

        function analyzeSessionPerformance() {
            const sessions = {
                'PRE_MARKET': { trades: [], totalPnl: 0, winCount: 0 },
                'INTRADAY': { trades: [], totalPnl: 0, winCount: 0 },
                'AFTER_HOUR': { trades: [], totalPnl: 0, winCount: 0 }
            };
            
            trades.forEach(trade => {
                if (trade.tradingSession && sessions[trade.tradingSession]) {
                    const pnl = calculatePnL(trade.entryPrice, trade.exitPrice, trade.shares, trade.directPnL, trade.commission || 0);
                    sessions[trade.tradingSession].trades.push(trade);
                    sessions[trade.tradingSession].totalPnl += pnl;
                    if (pnl > 0) sessions[trade.tradingSession].winCount++;
                }
            });
            
            return sessions;
        }

        function analyzeTimePerformance() {
            const timeCategories = {
                'MORNING': { trades: [], totalPnl: 0, winCount: 0 },
                'AFTERNOON': { trades: [], totalPnl: 0, winCount: 0 },
                'EVENING': { trades: [], totalPnl: 0, winCount: 0 }
            };
            
            trades.forEach(trade => {
                if (trade.entryDateTime) {
                    const timeCategory = determineTimeCategory(trade.entryDateTime);
                    const pnl = calculatePnL(trade.entryPrice, trade.exitPrice, trade.shares, trade.directPnL, trade.commission || 0);
                    if (timeCategories[timeCategory]) {
                        timeCategories[timeCategory].trades.push(trade);
                        timeCategories[timeCategory].totalPnl += pnl;
                        if (pnl > 0) timeCategories[timeCategory].winCount++;
                    }
                }
            });
            
            return timeCategories;
        }

        function updateTimeAnalysis() {
            try {
                const { winningTrades, losingTrades } = analyzeWinningTrades();
                const sessions = analyzeSessionPerformance();
                const timeCategories = analyzeTimePerformance();
                
                // Update winning trades statistics
                document.getElementById('winningTradesCount').textContent = winningTrades.length;
                document.getElementById('winningTradesPnl').textContent = '$' + winningTrades.reduce((sum, trade) => 
                    sum + calculatePnL(trade.entryPrice, trade.exitPrice, trade.shares, trade.directPnL, trade.commission || 0), 0).toFixed(2);
                document.getElementById('avgWinPnl').textContent = '$' + (winningTrades.length ? 
                    (winningTrades.reduce((sum, trade) => sum + calculatePnL(trade.entryPrice, trade.exitPrice, trade.shares, trade.directPnL, trade.commission || 0), 0) / winningTrades.length).toFixed(2) : '0.00');
                document.getElementById('maxWinPnl').textContent = '$' + (winningTrades.length ? 
                    Math.max(...winningTrades.map(trade => calculatePnL(trade.entryPrice, trade.exitPrice, trade.shares, trade.directPnL, trade.commission || 0))).toFixed(2) : '0.00');
                
                // Update losing trades statistics
                document.getElementById('losingTradesCount').textContent = losingTrades.length;
                document.getElementById('losingTradesPnl').textContent = '$' + losingTrades.reduce((sum, trade) => 
                    sum + calculatePnL(trade.entryPrice, trade.exitPrice, trade.shares, trade.directPnL, trade.commission || 0), 0).toFixed(2);
                document.getElementById('avgLossPnl').textContent = '$' + (losingTrades.length ? 
                    (losingTrades.reduce((sum, trade) => sum + calculatePnL(trade.entryPrice, trade.exitPrice, trade.shares, trade.directPnL, trade.commission || 0), 0) / losingTrades.length).toFixed(2) : '0.00');
                document.getElementById('maxLossPnl').textContent = '$' + (losingTrades.length ? 
                    Math.min(...losingTrades.map(trade => calculatePnL(trade.entryPrice, trade.exitPrice, trade.shares, trade.directPnL, trade.commission || 0))).toFixed(2) : '0.00');
                
                // Update session statistics
                Object.keys(sessions).forEach(session => {
                    const sessionData = sessions[session];
                    const elementId = session.toLowerCase().replace('_', '');
                    const element = document.getElementById(elementId + 'Trades');
                    if (element) {
                        element.textContent = sessionData.trades.length;
                        document.getElementById(elementId + 'Pnl').textContent = '$' + sessionData.totalPnl.toFixed(2);
                        document.getElementById(elementId + 'WinRate').textContent = sessionData.trades.length ? 
                            ((sessionData.winCount / sessionData.trades.length) * 100).toFixed(1) + '%' : '0%';
                        document.getElementById(elementId + 'AvgTime').textContent = sessionData.trades.length ? 
                            (sessionData.trades.reduce((sum, trade) => sum + (trade.tradeDuration || 0), 0) / sessionData.trades.length).toFixed(0) + 'm' : '0m';
                    }
                });
                
                // Update time statistics
                Object.keys(timeCategories).forEach(timeCat => {
                    const timeData = timeCategories[timeCat];
                    const element = document.getElementById(timeCat.toLowerCase() + 'Trades');
                    if (element) {
                        element.textContent = timeData.trades.length;
                        document.getElementById(timeCat.toLowerCase() + 'Pnl').textContent = '$' + timeData.totalPnl.toFixed(2);
                        document.getElementById(timeCat.toLowerCase() + 'WinRate').textContent = timeData.trades.length ? 
                            ((timeData.winCount / timeData.trades.length) * 100).toFixed(1) + '%' : '0%';
                    }
                });
            } catch (error) {
                console.error('Error in updateTimeAnalysis:', error);
            }
        }

        window.switchAnalysisTab = function(tabName) {
            document.querySelectorAll('.analysis-content').forEach(content => {
                content.classList.remove('active');
            });
            
            document.querySelectorAll('.analysis-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            document.getElementById(tabName).classList.add('active');
            
            // Activate the selected tab
            event.target.classList.add('active');
        };

        // ========== Export/Import Functions ==========
        window.toggleDateRange = () => {
            try {
                const period = document.getElementById('exportPeriod');
                const dateRangeSection = document.getElementById('dateRangeSection');
                
                if (period && dateRangeSection) {
                    if (period.value === 'custom') {
                        dateRangeSection.style.display = 'grid';
                    } else {
                        dateRangeSection.style.display = 'none';
                    }
                }
            } catch (error) {
                console.error('Error in toggleDateRange:', error);
            }
        };

        window.exportToExcel = function() {
            try {
                const period = document.getElementById('exportPeriod');
                const includeTrades = document.getElementById('includeTrades');
                const includeAnalytics = document.getElementById('includeAnalytics');
                const includePlan = document.getElementById('includePlan');
                
                if (!period || !includeTrades || !includeAnalytics || !includePlan) return;
                
                let startDate, endDate;
                
                if (period.value === 'custom') {
                    const startDateInput = document.getElementById('startDate');
                    const endDateInput = document.getElementById('endDate');
                    if (!startDateInput || !endDateInput) return;
                    startDate = new Date(startDateInput.value);
                    endDate = new Date(endDateInput.value);
                } else if (period.value === 'monthly') {
                    const now = new Date();
                    startDate = new Date(now.getFullYear(), now.getMonth(), 1);
                    endDate = new Date(now.getFullYear(), now.getMonth() + 1, 0);
                } else if (period.value === 'yearly') {
                    const now = new Date();
                    startDate = new Date(now.getFullYear(), 0, 1);
                    endDate = new Date(now.getFullYear(), 11, 31);
                } else {
                    startDate = new Date(0);
                    endDate = new Date();
                }
                
                startDate.setHours(0, 0, 0, 0);
                endDate.setHours(23, 59, 59, 999);
                
                const workbook = XLSX.utils.book_new();
                
                if (includeTrades.checked) {
                    const filteredTrades = trades.filter(trade => {
                        const tradeDate = new Date(trade.date + 'T00:00:00');
                        return tradeDate >= startDate && tradeDate <= endDate;
                    });
                    
                    const tradesData = filteredTrades.map(trade => {
                        const pnl = calculatePnL(trade.entryPrice, trade.exitPrice, trade.shares, trade.directPnL, trade.commission || 0);
                        return {
                            'Date': trade.date,
                            'Symbol': trade.symbol,
                            'Entry Price': trade.entryPrice,
                            'Exit Price': trade.exitPrice,
                            'Shares': trade.shares,
                            'Commission': trade.commission || 0,
                            'Direct PnL': trade.directPnL || 'N/A',
                            'Calculated PnL': pnl,
                            'Entry Time': trade.entryDateTime || 'N/A',
                            'Exit Time': trade.exitDateTime || 'N/A',
                            'Trading Session': trade.tradingSession || 'N/A',
                            'Trade Duration (min)': trade.tradeDuration || 'N/A',
                            'Time Category': trade.timeCategory || 'N/A',
                            'Notes': trade.notes || ''
                        };
                    });
                    
                    if (tradesData.length > 0) {
                        const tradesSheet = XLSX.utils.json_to_sheet(tradesData);
                        XLSX.utils.book_append_sheet(workbook, tradesSheet, 'Trades');
                    }

                    // Add No Trading Days for export
                    const noTradingDaysData = noTradingDays.map(date => ({
                        'Date': date,
                        'Type': 'No Trading Day',
                        'Notes': 'Marked as no trading activity'
                    }));
                    
                    if (noTradingDaysData.length > 0) {
                        const noTradingSheet = XLSX.utils.json_to_sheet(noTradingDaysData);
                        XLSX.utils.book_append_sheet(workbook, noTradingSheet, 'NoTradingDays');
                    }
                }
                
                if (includeAnalytics.checked) {
                    const analyticsData = [{
                        'Total Profit': document.getElementById('totalProfit') ? document.getElementById('totalProfit').textContent : '$0.00',
                        'Total Loss': document.getElementById('totalLoss') ? document.getElementById('totalLoss').textContent : '$0.00',
                        'Net P&L': document.getElementById('netPnl') ? document.getElementById('netPnl').textContent : '$0.00',
                        'Win Rate': document.getElementById('winRate') ? document.getElementById('winRate').textContent : '0%',
                        'Trading Days': document.getElementById('tradingDays') ? document.getElementById('tradingDays').textContent : '0',
                        'Weekend Days': document.getElementById('holidayDays') ? document.getElementById('holidayDays').textContent : '0',
                        'Remaining Days': document.getElementById('remainingDays') ? document.getElementById('remainingDays').textContent : '0',
                        'Total Month Days': document.getElementById('totalMonthDays') ? document.getElementById('totalMonthDays').textContent : '0'
                    }];
                    
                    const analyticsSheet = XLSX.utils.json_to_sheet(analyticsData);
                    XLSX.utils.book_append_sheet(workbook, analyticsSheet, 'Analytics');
                }
                
                if (includePlan.checked) {
                    const planData = [{
                        'Starting Capital': '$' + tradingPlan.capital.toFixed(2),
                        'Weekly Target': tradingPlan.weeklyTarget + '%',
                        'Monthly Target': tradingPlan.monthlyTarget + '%',
                        'Yearly Target': tradingPlan.yearlyTarget + '%'
                    }];
                    
                    const planSheet = XLSX.utils.json_to_sheet(planData);
                    XLSX.utils.book_append_sheet(workbook, planSheet, 'Trading Plan');
                }
                
                const timestamp = new Date().toISOString().slice(0, 19).replace(/:/g, '-');
                const filename = `Trading_Journal_${timestamp}.xlsx`;
                
                XLSX.writeFile(workbook, filename);
                
                alert('Data exported successfully!');
                closeModal('exportModal');
            } catch (error) {
                console.error('Error exporting data:', error);
                alert('Error exporting data. Please try again.');
            }
        };

        window.openImportModal = function() {
            document.getElementById('importModal').style.display = 'flex';
        };

        // ========== Import Excel Function ==========
        window.importFromExcel = function() {
            const fileInput = document.getElementById('importFile');
            const importTrades = document.getElementById('importTrades');
            const importPlan = document.getElementById('importPlan');
            const importNoTradingDays = document.getElementById('importNoTradingDays');
            const importStrategy = document.getElementById('importStrategy');
            
            if (!fileInput || !fileInput.files[0]) {
                alert('Please select a file to import');
                return;
            }
            
            const file = fileInput.files[0];
            const reader = new FileReader();
            
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    
                    let importedCount = 0;
                    
                    // Import trades
                    if (importTrades.checked && workbook.SheetNames.includes('Trades')) {
                        const tradesSheet = workbook.Sheets['Trades'];
                        const tradesData = XLSX.utils.sheet_to_json(tradesSheet);
                        
                        if (importStrategy.value === 'replace') {
                            trades.length = 0;
                        }
                        
                        tradesData.forEach(item => {
                            const newTrade = {
                                id: String(Date.now() + Math.random() + importedCount),
                                date: item.Date || new Date().toISOString().split('T')[0],
                                symbol: item.Symbol || 'DIRECT_PNL',
                                entryPrice: parseFloat(item['Entry Price']) || 0,
                                exitPrice: parseFloat(item['Exit Price']) || 0,
                                shares: parseInt(item.Shares) || 0,
                                commission: parseFloat(item.Commission) || 0,
                                directPnL: item['Direct PnL'] !== 'N/A' ? parseFloat(item['Direct PnL']) : undefined,
                                notes: item.Notes || '',
                                entryDateTime: item['Entry Time'] !== 'N/A' ? item['Entry Time'] : null,
                                exitDateTime: item['Exit Time'] !== 'N/A' ? item['Exit Time'] : null,
                                tradingSession: item['Trading Session'] !== 'N/A' ? item['Trading Session'] : 'INTRADAY',
                                tradeDuration: item['Trade Duration (min)'] !== 'N/A' ? parseInt(item['Trade Duration (min)']) : 30,
                                timeCategory: item['Time Category'] !== 'N/A' ? item['Time Category'] : null
                            };
                            
                            if (importStrategy.value === 'merge') {
                                const existingIndex = trades.findIndex(t => 
                                    t.date === newTrade.date && 
                                    t.symbol === newTrade.symbol && 
                                    t.entryPrice === newTrade.entryPrice
                                );
                                
                                if (existingIndex === -1) {
                                    trades.push(newTrade);
                                    importedCount++;
                                }
                            } else {
                                trades.push(newTrade);
                                importedCount++;
                            }
                        });
                    }
                    
                    // Import plan
                    if (importPlan.checked && workbook.SheetNames.includes('Trading Plan')) {
                        const planSheet = workbook.Sheets['Trading Plan'];
                        const planData = XLSX.utils.sheet_to_json(planSheet);
                        
                        if (planData.length > 0) {
                            const plan = planData[0];
                            if (plan['Starting Capital']) {
                                tradingPlan.capital = parseFloat(plan['Starting Capital'].replace('$', '')) || tradingPlan.capital;
                            }
                            if (plan['Weekly Target']) {
                                tradingPlan.weeklyTarget = parseFloat(plan['Weekly Target'].replace('%', '')) || tradingPlan.weeklyTarget;
                            }
                            if (plan['Monthly Target']) {
                                tradingPlan.monthlyTarget = parseFloat(plan['Monthly Target'].replace('%', '')) || tradingPlan.monthlyTarget;
                            }
                            if (plan['Yearly Target']) {
                                tradingPlan.yearlyTarget = parseFloat(plan['Yearly Target'].replace('%', '')) || tradingPlan.yearlyTarget;
                            }
                            importedCount++;
                        }
                    }
                    
                    // Import no trading days
                    if (importNoTradingDays.checked && workbook.SheetNames.includes('NoTradingDays')) {
                        const noTradingSheet = workbook.Sheets['NoTradingDays'];
                        const noTradingData = XLSX.utils.sheet_to_json(noTradingSheet);
                        
                        if (importStrategy.value === 'replace') {
                            noTradingDays.length = 0;
                        }
                        
                        noTradingData.forEach(item => {
                            if (item.Date && !noTradingDays.includes(item.Date)) {
                                noTradingDays.push(item.Date);
                                importedCount++;
                            }
                        });
                    }
                    
                    // Save all imported data
                    saveTrades();
                    saveTradingPlan();
                    saveNoTradingDays();
                    
                    // Update UI
                    renderCalendar();
                    renderPlanSummary();
                    updateAnalyticsChart();
                    updateDaysStatistics();
                    
                    alert(`Successfully imported ${importedCount} items`);
                    closeModal('importModal');
                    
                } catch (error) {
                    console.error('Error importing data:', error);
                    alert('Error importing data: ' + error.message);
                }
            };
            
            reader.onerror = function() {
                alert('Error reading file');
            };
            
            reader.readAsArrayBuffer(file);
        };

        // ========== Form Event Listeners ==========
        document.addEventListener('DOMContentLoaded', function() {
            // Load theme
            loadTheme();
            
            // Add event listeners for theme toggles
            const mobileThemeToggle = document.getElementById('mobileThemeToggle');
            const sidebarThemeToggle = document.getElementById('sidebarThemeToggle');
            
            if (mobileThemeToggle) {
                mobileThemeToggle.addEventListener('change', toggleTheme);
            }
            
            if (sidebarThemeToggle) {
                sidebarThemeToggle.addEventListener('change', toggleTheme);
            }
            
            // Add event listener for image preview
            const tradeImageInput = document.getElementById('tradeImage');
            if (tradeImageInput) {
                tradeImageInput.addEventListener('change', function(e) {
                    const file = e.target.files[0];
                    const preview = document.getElementById('previewImage');
                    const previewContainer = document.getElementById('tradeImagePreview');
                    
                    if (file && preview && previewContainer) {
                        const reader = new FileReader();
                        reader.onloadend = function() {
                            preview.src = reader.result;
                            previewContainer.style.display = 'block';
                        }
                        reader.readAsDataURL(file);
                    } else if (previewContainer) {
                        previewContainer.style.display = 'none';
                    }
                });
            }

            // Add event listeners for No Trading Day buttons
            const markNoTradingDayBtn = document.getElementById('markNoTradingDay');
            const unmarkNoTradingDayBtn = document.getElementById('unmarkNoTradingDay');
            
            if (markNoTradingDayBtn) {
                markNoTradingDayBtn.addEventListener('click', window.markAsNoTradingDay);
            }
            if (unmarkNoTradingDayBtn) {
                unmarkNoTradingDayBtn.addEventListener('click', window.unmarkNoTradingDay);
            }

            // Add event listener for hamburger menu
            const hamburgerMenu = document.getElementById('hamburgerMenu');
            if (hamburgerMenu) {
                hamburgerMenu.addEventListener('click', toggleMobileMenu);
            }

            // Close mobile menu when clicking outside
            document.addEventListener('click', function(event) {
                const mobileMenu = document.getElementById('mobileMenu');
                const hamburgerMenu = document.getElementById('hamburgerMenu');
                
                if (mobileMenu && hamburgerMenu && 
                    !mobileMenu.contains(event.target) && 
                    !hamburgerMenu.contains(event.target) &&
                    mobileMenu.classList.contains('active')) {
                    closeMobileMenu();
                }
            });

            // Add form event listeners
            const tradeForm = document.getElementById('tradeForm');
            if (tradeForm) {
                tradeForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    
                    const tradeId = document.getElementById('modalTradeId')?.value || '';
                    const dateString = document.getElementById('modalDate')?.value || '';
                    
                    const tradeModeToggle = document.getElementById('tradeModeToggle');
                    if (tradeModeToggle && tradeModeToggle.checked) return;

                    // Calculate duration
                    const entryDateTime = document.getElementById('entryTime')?.value || '';
                    const exitDateTime = document.getElementById('exitTime')?.value || '';
                    const tradeDuration = calculateTradeDuration(entryDateTime, exitDateTime);
                    const timeCategory = determineTimeCategory(entryDateTime);

                    const newTrade = {
                        id: tradeId || String(Date.now() + Math.random()),
                        date: dateString,
                        symbol: document.getElementById('symbol') ? document.getElementById('symbol').value.toUpperCase() : '',
                        entryPrice: document.getElementById('entryPrice') ? parseFloat(document.getElementById('entryPrice').value) : 0,
                        exitPrice: document.getElementById('exitPrice') ? parseFloat(document.getElementById('exitPrice').value) : 0,
                        shares: document.getElementById('shares') ? parseInt(document.getElementById('shares').value) : 0,
                        commission: document.getElementById('commission') ? parseFloat(document.getElementById('commission').value) || 0 : 0,
                        notes: document.getElementById('notes') ? document.getElementById('notes').value : '',
                        directPnL: undefined,
                        entryDateTime: entryDateTime,
                        exitDateTime: exitDateTime,
                        tradingSession: document.getElementById('tradingSession') ? document.getElementById('tradingSession').value : 'INTRADAY',
                        tradeDuration: tradeDuration,
                        timeCategory: timeCategory
                    };

                    if (tradeId) {
                        // Update existing trade
                        const index = trades.findIndex(t => t.id === tradeId);
                        if (index !== -1) {
                            trades[index] = newTrade;
                        }
                    } else {
                        // Add new trade
                        trades.push(newTrade);
                    }
                    
                    saveTrades();
                    renderCalendar();
                    renderPlanSummary();
                    updateTradesList(dateString);
                    closeModal('tradeModal');
                });
            }
            
            const simplePnLForm = document.getElementById('simplePnLForm');
            if (simplePnLForm) {
                simplePnLForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    
                    const dateString = document.getElementById('modalDate')?.value || '';
                    const pnlAmount = document.getElementById('directPnLAmount') ? parseFloat(document.getElementById('directPnLAmount').value) : 0;
                    const tradeId = document.getElementById('modalTradeId')?.value || '';
                    const notes = document.getElementById('simpleNotes') ? document.getElementById('simpleNotes').value : '';

                    if (isNaN(pnlAmount)) {
                        alert('Please enter a valid PnL amount');
                        return;
                    }

                    const newTrade = {
                        id: tradeId || String(Date.now() + Math.random()),
                        date: dateString,
                        symbol: 'DIRECT_PNL',
                        entryPrice: 0,
                        exitPrice: 0,
                        shares: 0,
                        commission: 0,
                        directPnL: pnlAmount,
                        notes: notes
                    };

                    if (tradeId) {
                        // Update existing trade
                        const index = trades.findIndex(t => t.id === tradeId);
                        if (index !== -1) {
                            trades[index] = newTrade;
                        }
                    } else {
                        // Add new trade
                        trades.push(newTrade);
                    }
                    
                    saveTrades();
                    renderCalendar();
                    renderPlanSummary();
                    updateTradesList(dateString);
                    closeModal('tradeModal');
                });
            }

            const userInfoForm = document.getElementById('userInfoForm');
            if (userInfoForm) {
                userInfoForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    
                    const newUserNameInput = document.getElementById('newUserName');
                    if (newUserNameInput) userInfo.name = newUserNameInput.value;
                    
                    const file = document.getElementById('profileImageUpload') ? document.getElementById('profileImageUpload').files[0] : null;
                    if (file) {
                        const reader = new FileReader();
                        reader.onloadend = function() {
                            userInfo.image = reader.result;
                            saveUserInfo();
                            loadUserInfo();
                            closeModal('userInfoModal');
                        }
                        reader.readAsDataURL(file);
                    } else {
                        saveUserInfo();
                        loadUserInfo();
                        closeModal('userInfoModal');
                    }
                });
            }

            const planForm = document.getElementById('planForm');
            if (planForm) {
                planForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    
                    const startingCapitalInput = document.getElementById('startingCapital');
                    const weeklyTargetGoalInput = document.getElementById('weeklyTargetGoal');
                    const monthlyTargetGoalInput = document.getElementById('monthlyTargetGoal');
                    const yearlyTargetGoalInput = document.getElementById('yearlyTargetGoal');
                    
                    if (startingCapitalInput) tradingPlan.capital = parseFloat(startingCapitalInput.value);
                    if (weeklyTargetGoalInput) tradingPlan.weeklyTarget = parseFloat(weeklyTargetGoalInput.value) || 0;
                    if (monthlyTargetGoalInput) tradingPlan.monthlyTarget = parseFloat(monthlyTargetGoalInput.value) || 0;
                    if (yearlyTargetGoalInput) tradingPlan.yearlyTarget = parseFloat(yearlyTargetGoalInput.value) || 0;
                    
                    saveTradingPlan();
                    renderCalendar();
                    closeModal('planModal');
                });
            }

            // Load user data
            loadUserInfo();
            
            // Initialize the application
            renderCalendar();
            renderPlanSummary();
            initializeAnalytics();
            updateDaysStatistics();
        });

        // ========== Data Loading Functions ==========
        function loadUserInfo() {
            try {
                const userNameDisplay = document.getElementById('userNameDisplay');
                const newUserNameInput = document.getElementById('newUserName');
                const profilePicture = document.getElementById('profilePicture');
                const defaultIcon = document.getElementById('defaultIcon');
                
                if (userNameDisplay) userNameDisplay.textContent = userInfo.name;
                if (newUserNameInput) newUserNameInput.value = userInfo.name;

                if (userInfo.image) {
                    if (profilePicture) {
                        profilePicture.src = userInfo.image;
                        profilePicture.style.display = 'block';
                    }
                    if (defaultIcon) defaultIcon.style.display = 'none';
                } else {
                    if (profilePicture) {
                        profilePicture.src = '';
                        profilePicture.style.display = 'none';
                    }
                    if (defaultIcon) defaultIcon.style.display = 'block';
                }
            } catch (error) {
                console.error('Error loading user info:', error);
            }
        }

        // Add resize event listener for responsive design
        window.addEventListener('resize', function() {
            renderCalendar();
        });

        // Initialize analytics after page load
        setTimeout(() => {
            initializeAnalytics();
            updateDaysStatistics();
        }, 1000);
    </script>
</body>
</html>
